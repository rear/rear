<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>Relax-and-Recover user guide</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Relax-and-Recover user guide</h1>
<span id="author">Dag Wieers, Jeroen Hoekx, Gratien Dhaese</span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This document describes everything there is to know regarding
Relax-and-Recover, an Open Source bare-metal disaster recovery and system
migration solution designed for Linux.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Relax-and-Recover is the leading Open Source bare metal disaster recovery
solution. It is a modular framework with many ready-to-go workflows for
common situations.</p></div>
<div class="paragraph"><p>Relax-and-Recover produces a bootable image which can recreate the system&#8217;s
original storage layout. Once that is done it initiates a restore from backup.
Since the storage layout can be modified prior to recovery, and disimilar
hardware and virtualization is supported, Relax-and-Recover offers the
flexibility to be used for complex system migrations.</p></div>
<div class="paragraph"><p>Currently Relax-and-Recover supports various boot media (incl. ISO, PXE,
OBDR tape, USB or eSATA storage), a variety of network protocols (incl.
sftp, ftp, http, nfs, cifs) as well as a multitude of backup strategies
(incl.  IBM TSM, HP Data Protector, Symantec NetBackup, EMC NetWorker [Legato],
SEP Sesam, Galaxy [Simpana], Bacula, Bareos, RBME, rsync, duplicity, Borg).</p></div>
<div class="paragraph"><p>Relax-and-Recover was designed to be easy to set up, requires no maintenance
and is there to assist when disaster strikes. Its setup-and-forget nature
removes any excuse for not having a disaster recovery solution implemented.</p></div>
<div class="paragraph"><p>Recovering from disaster is made very straight-forward by a 2-step recovery
process so that it can be executed by operational teams when required.
When used interactively (e.g. when used for migrating systems), menus help
make decisions to restore to a new (hardware) environment.</p></div>
<div class="paragraph"><p>Extending and integrating Relax-and-Recover into complex environments is made
possible by its modular framework. Consistent logging and optionally extended
output help understand the concepts behind Relax-and-Recover, troubleshoot
during initial configuration and help debug during integration.</p></div>
<div class="paragraph"><p>Professional services and support are available.</p></div>
<div class="sect2">
<h3 id="_relax_and_recover_project">1.1. Relax-and-Recover project</h3>
<div class="paragraph"><p>The support and development of the Relax-and-Recover project takes place
on Github:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Relax-and-Recover website
</dt>
<dd>
<p>
    <a href="http://relax-and-recover.org/">http://relax-and-recover.org/</a>
</p>
</dd>
<dt class="hdlist1">
Github project
</dt>
<dd>
<p>
    <a href="http://github.com/rear/rear/">http://github.com/rear/rear/</a>
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In case you have questions, ideas or feedback about this document, you
can contact the development team on the Relax-and-Recover mailinglist at:
<a href="mailto:rear-users@lists.relax-and-recover.org">rear-users@lists.relax-and-recover.org</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Note that you have to be subscribed to be able to send mails to the
Relax-and-Recover mailinglist. You can subscribe to the list at:
<a href="http://lists.relax-and-recover.org/mailman/listinfo/rear-users">http://lists.relax-and-recover.org/mailman/listinfo/rear-users</a></td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_design_concepts">1.2. Design concepts</h3>
<div class="paragraph"><p>Based on experience from previous projects, a set of design principles were
defined, and improved over time:</p></div>
<div class="ulist"><ul>
<li>
<p>
Focus on easy and automated disaster recovery
</p>
</li>
<li>
<p>
Modular design, focused on system administrators
</p>
</li>
<li>
<p>
For Linux (and possibly Unix operating systems)
</p>
</li>
<li>
<p>
Few external dependencies (Bash and standard Unix tools)
</p>
</li>
<li>
<p>
Easy to use and easy to extend
</p>
</li>
<li>
<p>
Easy to integrate with <strong>real</strong> backup software
</p>
</li>
</ul></div>
<div class="paragraph"><p>The goal is to make Relax-and-Recover as least demanding as possible, it will
require only the applications necessary to fulfill the job Relax-and-Recover
is configured for.</p></div>
<div class="paragraph"><p>Furthermore, Relax-and-Recover should be platform independent and ideally
install just as a set of scripts that utilizes everything that the Linux
operating system provides.</p></div>
</div>
<div class="sect2">
<h3 id="_features_and_functionality">1.3. Features and functionality</h3>
<div class="paragraph"><p>Relax-and-Recover has a wide range of features:</p></div>
<div class="ulist"><ul>
<li>
<p>
Improvements to HP SmartArray and CCISS driver integration
</p>
</li>
<li>
<p>
Improvements to software RAID integration
</p>
</li>
<li>
<p>
Disk layout change detection for monitoring
</p>
</li>
<li>
<p>
One-Button-Disaster-Recovery (OBDR) tape support
</p>
</li>
<li>
<p>
DRBD filesystem support
</p>
</li>
<li>
<p>
Bacula or Bareos tape support
</p>
</li>
<li>
<p>
Multiple DR images per system on single USB storage device
</p>
</li>
<li>
<p>
USB ext3/ext4 support
</p>
</li>
<li>
<p>
GRUB[2] bootloader re-implementation
</p>
</li>
<li>
<p>
UEFI support
</p>
</li>
<li>
<p>
ebiso support (needed by SLES UEFI ISO booting)
</p>
</li>
<li>
<p>
Add Relax-and-Recover entry to local GRUB configuration (optional)
</p>
</li>
<li>
<p>
Nagios and webmin integration
</p>
</li>
<li>
<p>
Syslinux boot menu
</p>
</li>
<li>
<p>
Storing rescue/backup logfile on rescue media
</p>
</li>
<li>
<p>
Restoring to different hardware
</p>
</li>
<li>
<p>
RHEL5, RHEL6 and RHEL7 support
</p>
</li>
<li>
<p>
SLES 11 and SLES 12 support
</p>
</li>
<li>
<p>
Debian and Ubuntu support
</p>
</li>
<li>
<p>
Various usability improvements
</p>
</li>
<li>
<p>
Serial console support auto-detected
</p>
</li>
<li>
<p>
Lockless workflows
</p>
</li>
<li>
<p>
USB udev integration to trigger mkrescue on inserting USB device
</p>
</li>
<li>
<p>
Beep/UID led/USB suspend integration
</p>
</li>
<li>
<p>
Migrate UUID from disks and MAC addressed from network interfaces
</p>
</li>
<li>
<p>
Integrates with Disaster Recovery Linux Manager (DRLM)
</p>
</li>
<li>
<p>
Data deduplication with Borg as backend
</p>
</li>
<li>
<p>
Block device level backup/restore
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">2. Getting started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_software_requirements">2.1. Software requirements</h3>
<div class="paragraph"><p>Relax-and-Recover aims to have as little dependencies as possible, however
over time certain capabilities were added using utilities and specific
features, causing older distributions to fall out of support. We try to avoid
this where practically possible and be conservative to add new dependencies.</p></div>
<div class="paragraph"><p>The most basic requirement for Relax-and-Recover is having <code>bash</code>, and
ubiquitous Linux tools like:</p></div>
<div class="ulist"><ul>
<li>
<p>
dd (coreutils)
</p>
</li>
<li>
<p>
ethtool
</p>
</li>
<li>
<p>
file
</p>
</li>
<li>
<p>
grep
</p>
</li>
<li>
<p>
gzip
</p>
</li>
<li>
<p>
ip (iproute[2])
</p>
</li>
<li>
<p>
mount (util-linux-ng)
</p>
</li>
<li>
<p>
ps (procps)
</p>
</li>
<li>
<p>
sed
</p>
</li>
<li>
<p>
ssh (openssh-clients)
</p>
</li>
<li>
<p>
strings (binutils)
</p>
</li>
<li>
<p>
tar
</p>
</li>
<li>
<p>
&#8230;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Optionally, some use-cases require other tools:</p></div>
<div class="ulist"><ul>
<li>
<p>
lsscsi and sg3_utils (for OBDR tape support)
</p>
</li>
<li>
<p>
mkisofs or genisoimage (for ISO output support)
</p>
</li>
<li>
<p>
syslinux (for ISO or USB output support)
</p>
</li>
<li>
<p>
syslinux-extlinux (for USB support)
</p>
</li>
<li>
<p>
ebiso (for SLES UEFI booting)
</p>
</li>
</ul></div>
<div class="paragraph"><p>In some cases having newer versions of tools may provide better support:</p></div>
<div class="ulist"><ul>
<li>
<p>
syslinux &gt;= 4.00 (provides menu support)
</p>
</li>
<li>
<p>
parted
</p>
</li>
</ul></div>
<div class="paragraph"><p>In case we are using <code>BACKUP=NETFS</code> with nfs or cifs we might need also:</p></div>
<div class="ulist"><ul>
<li>
<p>
nfs-client
</p>
</li>
<li>
<p>
cifs-utils
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_distribution_support">2.2. Distribution support</h3>
<div class="paragraph"><p>As a project our aim is not to exclude any distribution from being supported,
however (as already noted) some older distributions fell out of support over
time and there is little interest from the project or the community to spend
the effort to add this support.</p></div>
<div class="paragraph"><p>On the other hand there is a larger demand for a tool like Relax-and-Recover
from the Enterprise Linux distributions, and as a result more people are
testing and contributing to support those distributions.</p></div>
<div class="paragraph"><p>Currently we aim to support the following distributions by testing them
regularly:</p></div>
<div class="ulist"><ul>
<li>
<p>
Red Hat Enterprise Linux and derivatives: RHEL5, RHEL6 and RHEL7
</p>
</li>
<li>
<p>
SUSE Linux Enterprise Server 11 and 12
</p>
</li>
<li>
<p>
Ubuntu LTS: 12, 13, 14 and 15
</p>
</li>
</ul></div>
<div class="paragraph"><p>Distributions dropped as supported:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ubuntu LTS &lt;12
</p>
</li>
<li>
<p>
Fedora &lt;21
</p>
</li>
<li>
<p>
RHEL 3 and 4
</p>
</li>
<li>
<p>
SLES 9 and 10
</p>
</li>
<li>
<p>
openSUSE &lt;11
</p>
</li>
<li>
<p>
Debian &lt;6
</p>
</li>
</ul></div>
<div class="paragraph"><p>Distributions known to be <em>unsupported</em> are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ubuntu LTS 8.04 (as it does not implement <code>grep -P</code>)
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_known_limitations">2.3. Known limitations</h3>
<div class="paragraph"><p>Relax-and-Recover offers a lot of flexibility in various use-cases, however it
does have some limitations under certain circumstances:</p></div>
<div class="ulist"><ul>
<li>
<p>
Relax-and-Recover depends on the software of the running system. When
   recovering this system to newer hardware, it is possible that the hardware
   support of the original system does not support the newer hardware.
</p>
<div class="paragraph"><p>This problem has been seen when restoring an older RHEL4 with an older HP
Proliant Support Pack (PSP) to more recent hardware. This PSP did not detect
the newer HP SmartArray controller or its firmware.</p></div>
</li>
<li>
<p>
Relax-and-Recover supports recovering to different hardware, but it cannot
   always automatically adapt to this new environment. In such cases it
   requires a manual intervention to e.g.
</p>
<div class="ulist"><ul>
<li>
<p>
modify the <em>disklayout.conf</em> to indicate the number of controller, disks
     or specific custom desires during restore
</p>
</li>
<li>
<p>
reduce the partition-sizes/LV-sizes when restoring to smaller storage
</p>
</li>
<li>
<p>
pull network-media or configure the network interfaces manually
</p>
</li>
</ul></div>
</li>
<li>
<p>
Depending on your back-up strategy you may have to perform actions, like:
</p>
<div class="ulist"><ul>
<li>
<p>
insert the required tape(s)
</p>
</li>
<li>
<p>
perform commands to restore the backup
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_installation">2.4. Installation</h3>
<div class="paragraph"><p>You can find the RPM and DEB packages from our web site at <a href="http://relax-and-recover.org/download/">http://relax-and-recover.org/download/</a></p></div>
<div class="paragraph"><p>The latest stable versions of Fedora and SLES can be installed via <code>yum</code> and <code>zypper</code></p></div>
<div class="sect3">
<h4 id="_from_rpm_packages">2.4.1. From RPM packages</h4>
<div class="paragraph"><p>Simply install (or update) the provided packages using
the command: <code>rpm -Uhv rear-1.17-1.fc20.noarch.rpm</code></p></div>
<div class="paragraph"><p>You can test your installation by running <code>rear dump</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear dump
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Dumping out configuration and system information
System definition:
                                    ARCH = Linux-x86_64
                                      OS = GNU/Linux
                               OS_VENDOR = RedHatEnterpriseServer
                              OS_VERSION = 5.6
...</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_from_deb_packages">2.4.2. From DEB packages</h4>
<div class="paragraph"><p>On a Debian system (or Ubuntu) you can download the DEB packages from our download page and install it with the command:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>dpkg -i rear*.deb</code></pre>
</div></div>
<div class="paragraph"><p>On Debian (Ubuntu) use the following command to install missing dependencies:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>apt-get -f install</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_from_source">2.4.3. From source</h4>
<div class="paragraph"><p>The latest and greatest sources are available at GitHub location : <a href="https://github.com/rear/rear">https://github.com/rear/rear</a></p></div>
<div class="paragraph"><p>To make local copy with our github repository just type:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone git@github.com:rear/rear.git</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_file_locations">2.5. File locations</h3>
<div class="paragraph"><p>Remember the general configuration file is found at <code>/usr/share/rear/conf/default.conf</code>. In that file you find all variables used by <code>rear</code> which can be overruled by redefining these in the <code>/etc/rear/site.conf</code> or <code>/etc/rear/local.conf</code> files. Please do not modify the <code>default.conf</code> file itself, but use the <code>site.conf</code> or <code>local.conf</code> for this purpose.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Important note about the configuration files inside ReaR. Treat these as Bash scripts! ReaR will source these configuration files, and therefore, if you make any syntax error against Bash scripting rules ReaR will break.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">3. Configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>The configuration is performed by changing <em>/etc/rear/local.conf</em> or
<em>/etc/rear/site.conf</em>.</p></div>
<div class="paragraph"><p>There are two important variables that influence Relax-and-Recover and
the rescue image. Set <code>OUTPUT</code> to your preferred boot method and define
<code>BACKUP</code> for your favorite <code>BACKUP</code> strategy.</p></div>
<div class="paragraph"><p>In most cases only these two settings are required.</p></div>
<div class="sect2">
<h3 id="_rescue_media_output">3.1. Rescue media (OUTPUT)</h3>
<div class="paragraph"><p>The <code>OUTPUT</code> variable defines where the rescue image should be send to.
Possible <code>OUTPUT</code> setting are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
OUTPUT=RAMDISK
</dt>
<dd>
<p>
Copy the kernel and the initramfs containing the rescue system to a selected
location.
</p>
</dd>
<dt class="hdlist1">
OUTPUT=ISO
</dt>
<dd>
<p>
Create a bootable ISO9660 image on disk as <em>rear-$(hostname).iso</em>
</p>
</dd>
<dt class="hdlist1">
OUTPUT=PXE
</dt>
<dd>
<p>
Create on a remote PXE/NFS server the required files (such as configuration
file, kernel and initrd image)
</p>
</dd>
<dt class="hdlist1">
OUTPUT=OBDR
</dt>
<dd>
<p>
Create a bootable OBDR tape including the backup archive. Specify the OBDR
tape device by using <code>TAPE_DEVICE</code>.
</p>
</dd>
<dt class="hdlist1">
OUTPUT=USB
</dt>
<dd>
<p>
Create a bootable USB disk (using extlinux). Specify the USB storage device by
using <code>USB_DEVICE</code>.
</p>
</dd>
</dl></div>
<div class="sect3">
<h4 id="_using_iso_as_output_method">3.1.1. Using ISO as output method</h4>
<div class="paragraph"><p>When using <code>OUTPUT=ISO</code> or <code>OUTPUT=RAMDISK</code> you should provide the backup target
location through the <code>OUTPUT_URL</code> variable. Possible <code>OUTPUT_URL</code> settings are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
OUTPUT_URL=file://
</dt>
<dd>
<p>
Write the ISO image to disk. The default is in <em>/var/lib/rear/output/</em>.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=fish//
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the FISH protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=ftp://
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the FTP protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=ftps://
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the FTPS protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=hftp://
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the HFTP protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=http://
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the HTTP (PUT) procotol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=https://
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the HTTPS (PUT) protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=nfs://
</dt>
<dd>
<p>
Write the ISO image using <code>nfs</code> and the NFS protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=sftp://
</dt>
<dd>
<p>
Write the ISO image using <code>lftp</code> and the secure FTP (SFTP) protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=rsync://
</dt>
<dd>
<p>
Write the ISO image using <code>rsync</code> and the RSYNC protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=sshfs://
</dt>
<dd>
<p>
Write the image using sshfs and the SSH protocol.
</p>
</dd>
<dt class="hdlist1">
OUTPUT_URL=null
</dt>
<dd>
<p>
Do not copy the ISO image from <em>/var/lib/rear/output/</em> to a remote output location.
<code>OUTPUT_URL=null</code> is useful when another program (e.g. an <em>external</em> backup program)
is used to save the ISO image from the local system to a remote place,
or with <code>BACKUP_URL=iso:///backup</code> when the backup is included in the ISO image
to avoid a (big) copy of the ISO image at a remote output location.
In the latter case the ISO image must be manually saved from the local system to a remote place.
<code>OUTPUT_URL=null</code> is only supported together with <code>BACKUP=NETFS</code>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The default boot option of the created ISO is boothd / "boot from first harddisk". If you want to change this,
e.g. because you integrate REAR into some automation process, you can change the default using
<em>ISO_DEFAULT={manual,automatic,boothd}</em></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_backup_restore_strategy_backup">3.2. Backup/Restore strategy (BACKUP)</h3>
<div class="paragraph"><p>The <code>BACKUP</code> setting defines our backup/restore strategy. The <code>BACKUP</code> can be handled via internal archive executable (<code>tar</code> or <code>rsync</code>) or by an external backup program (commercial or open source).</p></div>
<div class="paragraph"><p>Possible <code>BACKUP</code> settings are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
BACKUP=TSM
</dt>
<dd>
<p>
Use IBM Tivoli Storage Manager programs
</p>
</dd>
<dt class="hdlist1">
BACKUP=DP
</dt>
<dd>
<p>
Use HP DataProtector programs
</p>
</dd>
<dt class="hdlist1">
BACKUP=FDRUPSTREAM
</dt>
<dd>
<p>
Use FDR/Upstream
</p>
</dd>
<dt class="hdlist1">
BACKUP=NBU
</dt>
<dd>
<p>
Use Symantec NetBackup programs
</p>
</dd>
<dt class="hdlist1">
BACKUP=NSR
</dt>
<dd>
<p>
Use EMC NetWorker (Legato)
</p>
</dd>
<dt class="hdlist1">
BACKUP=BACULA
</dt>
<dd>
<p>
Use Bacula programs
</p>
</dd>
<dt class="hdlist1">
BACKUP=BAREOS
</dt>
<dd>
<p>
Use Bareos fork of Bacula
</p>
</dd>
</dl></div>
<div class="paragraph"><p>BAREOS_FILESET=Full
Only if you have more than one fileset defined for your clients backup jobs, you need to specify which
to use for restore</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
BACKUP=GALAXY
</dt>
<dd>
<p>
Use CommVault Galaxy (5, probably 6)
</p>
</dd>
<dt class="hdlist1">
BACKUP=GALAXY7
</dt>
<dd>
<p>
Use CommVault Galaxy (7 and probably newer)
</p>
</dd>
<dt class="hdlist1">
BACKUP=GALAXY10
</dt>
<dd>
<p>
Use CommVault Galaxy 10 (or Simpana 10)
</p>
</dd>
<dt class="hdlist1">
BACKUP=BORG
</dt>
<dd>
<p>
Use BorgBackup (short Borg) a deduplicating backup program to restore the data.
</p>
</dd>
<dt class="hdlist1">
BACKUP=NETFS
</dt>
<dd>
<p>
Use Relax-and-Recover internal backup with tar or rsync (or similar).
When using <code>BACKUP=NETFS</code> and <code>BACKUP_PROG=tar</code> there is an option to select
<code>BACKUP_TYPE=incremental</code> or <code>BACKUP_TYPE=differential</code> to let rear make
incremental or differential backups until the next full backup day
e.g. via <code>FULLBACKUPDAY="Mon"</code> is reached or when the last full backup
is too old after FULLBACKUP_OUTDATED_DAYS has passed.
Incremental or differential backup is currently only known to work
with <code>BACKUP_URL=nfs</code>. Other BACKUP_URL schemes may work but
at least <code>BACKUP_URL=usb</code> requires USB_SUFFIX to be set
to work with incremental or differential backup.
</p>
</dd>
<dt class="hdlist1">
BACKUP=REQUESTRESTORE
</dt>
<dd>
<p>
No backup, just ask user to somehow restore the filesystems.
</p>
</dd>
<dt class="hdlist1">
BACKUP=EXTERNAL
</dt>
<dd>
<p>
Use a custom strategy by providing backup and restore commands.
</p>
</dd>
<dt class="hdlist1">
BACKUP=DUPLICITY
</dt>
<dd>
<p>
Use duplicity to manage backup (see <a href="http://duplicity.nongnu.org">http://duplicity.nongnu.org</a>). Additionally if duply
(see <a href="http://duply.net">http://duply.net</a>) is also installed while generating the rescue images it is
part of the image.
</p>
</dd>
<dt class="hdlist1">
BACKUP=RBME
</dt>
<dd>
<p>
Use Rsync Backup Made Easy (rbme) to restore the data.
</p>
</dd>
<dt class="hdlist1">
BACKUP=RSYNC
</dt>
<dd>
<p>
Use rsync to foresee in backup and restore of your system disks.
</p>
</dd>
<dt class="hdlist1">
BACKUP=BLOCKCLONE
</dt>
<dd>
<p>
Backup block devices using dd or ntfsclone
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_using_netfs_as_backup_strategy_internal_archive_method">3.3. Using NETFS as backup strategy (internal archive method)</h3>
<div class="paragraph"><p>When using <code>BACKUP=NETFS</code> you should provide the backup target location through
the <code>BACKUP_URL</code> variable. Possible <code>BACKUP_URL</code> settings are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
BACKUP_URL=file://
</dt>
<dd>
<p>
To backup to local disk, use <code>BACKUP_URL=file:///directory/path/</code>
</p>
</dd>
<dt class="hdlist1">
BACKUP_URL=nfs://
</dt>
<dd>
<p>
To backup to NFS disk, use <code>BACKUP_URL=nfs://nfs-server-name/share/path</code>
</p>
</dd>
<dt class="hdlist1">
BACKUP_URL=tape://
</dt>
<dd>
<p>
To backup to tape device, use <code>BACKUP_URL=tape:///dev/nst0</code> or alternatively,
simply define <code>TAPE_DEVICE=/dev/nst0</code>
</p>
</dd>
<dt class="hdlist1">
BACKUP_URL=cifs://
</dt>
<dd>
<p>
To backup to a Samba share (CIFS), use
<code>BACKUP_URL=cifs://cifs-server-name/share/path</code>. To provide credentials for
CIFS mounting use a <em>/etc/rear/cifs</em> credentials file and define
<code>BACKUP_OPTIONS="cred=/etc/rear/cifs"</code> and pass along:
</p>
<div class="listingblock">
<div class="content">
<pre><code>username=_username_
password=_secret password_
domain=_domain_</code></pre>
</div></div>
</dd>
<dt class="hdlist1">
BACKUP_URL=sshfs://
</dt>
<dd>
<p>
To backup over the network with the help of sshfs. You need the fuse-sshfs package before you can use FUSE-Filesystem to access remote filesystems via SSH. An example of defining the <code>BACKUP_URL</code> could be:
</p>
<div class="listingblock">
<div class="content">
<pre><code>BACKUP_URL=sshfs://root@server/export/archives</code></pre>
</div></div>
</dd>
<dt class="hdlist1">
BACKUP_URL=usb://
</dt>
<dd>
<p>
To backup to USB storage device, use <code>BACKUP_URL=usb:///dev/disk/by-label/REAR-000</code>
or use a real device node or a specific filesystem label. Alternatively, you
can specify the device using <code>USB_DEVICE=/dev/disk/by-label/REAR-000</code>.
</p>
<div class="paragraph"><p>If you combine this with <code>OUTPUT=USB</code> you will end up with a bootable USB device.</p></div>
</dd>
</dl></div>
<div class="paragraph"><p>Optional settings:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
BACKUP_PROG=rsync
</dt>
<dd>
<p>
If you want to use rsync instead of tar (only for <code>BACKUP=NETFS</code>). Do not confuse this with the <code>BACKUP=RSYNC</code> backup mechanism.
</p>
</dd>
<dt class="hdlist1">
NETFS_KEEP_OLD_BACKUP_COPY=y
</dt>
<dd>
<p>
If you want to keep the previous backup archive.
Incremental or differential backup and NETFS_KEEP_OLD_BACKUP_COPY contradict each other so that
<code>NETFS_KEEP_OLD_BACKUP_COPY</code> must not be <em>true</em> in case of incremental or differential backup.
</p>
</dd>
<dt class="hdlist1">
TMPDIR=/bigdisk
</dt>
<dd>
<p>
Define this variable in <code>/etc/rear/local.conf</code> if directoru <code>/tmp</code> is too small to contain the ISO image, e.g. when using
</p>
<div class="literalblock">
<div class="content">
<pre><code>OUTPUT=ISO
BACKUP=NETFS
BACKUP_URL=iso://backup
ISO_MAX_SIZE=4500
OUTPUT_URL=nfs://lnx01/vol/lnx01/linux_images_dr</code></pre>
</div></div>
</dd>
</dl></div>
<div class="paragraph"><p>The <code>TMPDIR</code> is picked up by the <code>mktemp</code> command to create the <code>BUILD_DIR</code> under <code>/bigdisk/tmp/rear.XXXX</code>
Please be aware, that directory <code>/bigdisk</code> must exist, otherwise, <code>rear</code> will bail out when executing the <code>mktemp</code> command.
The default value of <code>TMPDIR</code> is an empty string, therefore, by default <code>BUILD_DIR</code> is <code>/tmp/rear.XXXX</code></p></div>
<div class="paragraph"><p>Another point of interest is the <code>ISO_DIR</code> variable to choose another location of the ISO image instead of the default location (<code>/var/lib/rear/output</code>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">With <code>USB</code> we refer to all kinds of external storage devices, like USB
keys, USB disks, eSATA disks, ZIP drives, etc&#8230;</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_using_rsync_as_backup_mechanism">3.4. Using RSYNC as backup mechanism</h3>
<div class="paragraph"><p>When using <code>BACKUP=RSYNC</code> you should provide the backup target location through
the <code>BACKUP_URL</code> variable. Possible <code>BACKUP_URL</code> settings are:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>BACKUP_URL=rsync://root@server/export/archives
BACKUP_URL=rsync://root@server::/export/archives</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scenarios">4. Scenarios</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_bootable_iso">4.1. Bootable ISO</h3>
<div class="paragraph"><p>If you simply want a bootable ISO on a central server, you would do:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">OUTPUT_URL</span><span style="color: #990000">=</span>http<span style="color: #990000">:</span>//server/path-to-push<span style="color: #990000">/</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_bootable_iso_with_an_external_commercial_backup_software">4.2. Bootable ISO with an external (commercial) backup software</h3>
<div class="paragraph"><p>If you rely on your backup software to do the full restore of a system then you could define:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">BACKUP</span><span style="color: #990000">=[</span>TSM<span style="color: #990000">|</span>NSR<span style="color: #990000">|</span>DP<span style="color: #990000">|</span>NBU<span style="color: #990000">|</span>GALAXY10<span style="color: #990000">|</span>SEP<span style="color: #990000">|</span>DUPLICITY<span style="color: #990000">|</span>BACULA<span style="color: #990000">|</span>BAREOS<span style="color: #990000">|</span>RBME<span style="color: #990000">|</span>FDRUPSTREAM<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>When using one of the above backup solution (commercial or open source) then there is no need to use <code>rear mkbackup</code> as the backup workflow would be empty. Just use <code>rear mkrescue</code></p></div>
<div class="paragraph"><p>ReaR will incorporate the needed executables and libraries of your chosen backup solution into the rescue image of ReaR.</p></div>
</div>
<div class="sect2">
<h3 id="_bootable_iso_and_storing_archive_on_nfs_nas">4.3. Bootable ISO and storing archive on NFS/NAS</h3>
<div class="paragraph"><p>To create an ISO rescue image and using a central NFS/NAS server to store the archive, you could define:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">BACKUP_URL</span><span style="color: #990000">=</span>nfs<span style="color: #990000">:</span>//remote-nfs-server/exports
<span style="font-style: italic"><span style="color: #9A1900">#BACKUP_PROG_CRYPT_ENABLED=1</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#BACKUP_PROG_CRYPT_KEY="my_Secret_pw"</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above example shows that it is even possible to protect the archives with a password.  Be aware, that the password entry <code>BACKUP_PROG_CRYPT_KEY="my_Secret_pw"</code> will be deleted in the <code>/etc/rear/local.conf</code> file within the rescue image. So, it is important to remember the password (if you use the rescue image months later could cause problems I guess).</p></div>
</div>
<div class="sect2">
<h3 id="_bootable_usb_device_with_backup_to_usb">4.4. Bootable USB device with backup to USB</h3>
<div class="paragraph"><p>If you want a bootable USB device with a (tar) backup to USB as well, you
would use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>USB
<span style="color: #009900">USB_DEVICE</span><span style="color: #990000">=</span>/dev/disk/by-label/REAR-<span style="color: #993399">000</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_bootable_tape_drive_obdr_with_backup_to_tape">4.5. Bootable tape drive (OBDR) with backup to tape</h3>
<div class="paragraph"><p>If you want an OBDR image and backup on tape, and use GNU tar for
backup/restore, you would use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>OBDR
<span style="color: #009900">TAPE_DEVICE</span><span style="color: #990000">=</span>/dev/nst<span style="color: #993399">0</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_bootable_tape_drive_obdr_and_bacula_restore">4.6. Bootable tape drive (OBDR) and Bacula restore</h3>
<div class="paragraph"><p>If you want an OBDR image on tape, and the Bacula tools to recover your
backup, use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>BACULA
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>OBDR
<span style="color: #009900">TAPE_DEVICE</span><span style="color: #990000">=</span>/dev/nst<span style="color: #993399">0</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_bootable_iso_with_borg">4.7. Bootable ISO with Borg</h3>
<div class="ulist"><ul>
<li>
<p>
Install Borg backup (<a href="https://borgbackup.readthedocs.io/en/stable/installation.html">https://borgbackup.readthedocs.io/en/stable/installation.html</a>).
</p>
</li>
<li>
<p>
Setup ssh key infrastructure for user that will be running backup.
Issuing following command must work without any password prompts or remote host identity confirmation:
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>ssh &lt;BORGBACKUP_USERNAME&gt;@&lt;BORGBACKUP_HOST&gt;</code></p></div>
<div class="ulist"><ul>
<li>
<p>
Example <em>local.conf</em>:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">OUTPUT_URL</span><span style="color: #990000">=</span>nfs<span style="color: #990000">:</span>//foo<span style="color: #990000">.</span>bar<span style="color: #990000">.</span>xy/mnt/backup/iso

<span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>BORG
<span style="color: #009900">BORGBACKUP_HOST</span><span style="color: #990000">=</span><span style="color: #FF0000">"foo.bar.xy"</span>
<span style="color: #009900">BORGBACKUP_USERNAME</span><span style="color: #990000">=</span><span style="color: #FF0000">"borg_user"</span>
<span style="color: #009900">BORGBACKUP_REPO</span><span style="color: #990000">=</span><span style="color: #FF0000">"/mnt/backup/client"</span>
<span style="color: #009900">BORGBACKUP_REMOTE_PATH</span><span style="color: #990000">=</span><span style="color: #FF0000">"/usr/local/bin/borg"</span>

<span style="font-style: italic"><span style="color: #9A1900"># Automatic archive pruning</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># (https://borgbackup.readthedocs.io/en/stable/usage.html#borg-prune)</span></span>
<span style="color: #009900">BORGBACKUP_PRUNE_WEEKLY</span><span style="color: #990000">=</span><span style="color: #993399">2</span>

<span style="font-style: italic"><span style="color: #9A1900"># Archive compression</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># (https://borgbackup.readthedocs.io/en/stable/usage.html#borg-create)</span></span>
<span style="color: #009900">BORGBACKUP_COMPRESSION</span><span style="color: #990000">=</span><span style="color: #FF0000">"lzma,9"</span>     <span style="font-style: italic"><span style="color: #9A1900"># Slowest backup, best compression</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Repository encryption</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># (https://borgbackup.readthedocs.io/en/stable/usage.html#borg-init)</span></span>
<span style="color: #009900">BORGBACKUP_ENC_TYPE</span><span style="color: #990000">=</span><span style="color: #FF0000">"keyfile"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_PASSPHRASE</span><span style="color: #990000">=</span><span style="color: #FF0000">"S3cr37_P455w0rD"</span>
<span style="color: #009900">COPY_AS_IS_BORG</span><span style="color: #990000">=(</span> <span style="color: #FF0000">"/root/.config/borg/keys/"</span> <span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Borg environment variables</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># (https://borgbackup.readthedocs.io/en/stable/usage.html#environment-variables)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_RELOCATED_REPO_ACCESS_IS_OK</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If using BORGBACKUP_ENC_TYPE="keyfile", don&#8217;t forget to make your
           encryption key available for case of restore!
           (using <code>COPY_AS_IS_BORG=( "/root/.config/borg/keys/" )</code> is a option to consider).
           Be sure to read <a href="https://borgbackup.readthedocs.io/en/stable/usage.html#borg-init">https://borgbackup.readthedocs.io/en/stable/usage.html#borg-init</a>,
           and make your self familiar how encryption in Borg works.</td>
</tr></table>
</div>
<div class="ulist"><ul>
<li>
<p>
Executing <code>rear mkbackup</code> will create Relax-and-Recover rescue/recovery system and
 start Borg backup process. Once backup finishes, it will also prune old archives from repository,
 if at least one of BORGBACKUP_PRUNE_* variables is set.
</p>
</li>
<li>
<p>
To recover your system, boot Relax-and-Recover rescue/recovery system and trigger <code>rear recover</code>.
 You will be prompted which archive to recover from Borg repository, once ReaR finished with layout configuration.
</p>
</li>
</ul></div>
<div class="paragraph"><p>```
&#8230;
Disk layout created.
Starting Borg restore</p></div>
<div class="sect3">
<h4 id="_borg_archives_list">4.7.1. Borg archives list</h4>
<div class="paragraph"><p>Host:       foo.bar.xy
Repository: /mnt/backup/client</p></div>
<div class="paragraph"><p>[1] rear_1      Sun, 2016-10-16 14:08:16
[2] rear_2      Sun, 2016-10-16 14:32:11</p></div>
<div class="paragraph"><p>[3] Exit</p></div>
<div class="paragraph"><p>Choose archive to recover from:</p></div>
<div class="paragraph"><p>```</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_backup_restore_alien_file_system_using_blockclone_and_dd">4.8. Backup/restore alien file system using BLOCKCLONE and dd</h3>
<div class="sect3">
<h4 id="_configuration_2">4.8.1. Configuration</h4>
<div class="ulist"><ul>
<li>
<p>
First we need to set some global options to <em>local.conf</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>```
# cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://beta.virtual.sk/mnt/rear
```</p></div>
<div class="ulist"><ul>
<li>
<p>
Now we can define variables that will apply only for targeted block device
</p>
</li>
</ul></div>
<div class="paragraph"><p>```
# cat alien.conf
BACKUP=BLOCKCLONE                                        # Define BLOCKCLONE as backup method
BACKUP_PROG_ARCHIVE="alien"                              # Name of image file
BACKUP_PROG_SUFFIX=".dd.img"                             # Suffix of image file
BACKUP_PROG_COMPRESS_SUFFIX=""                           # Clear additional suffixes</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=dd                                       # Use dd for image creation
BLOCKCLONE_PROG_OPTS="bs=4k"                             # Additional options that will be passed to dd
BLOCKCLONE_SOURCE_DEV="/dev/sdc1"                        # Device that should be backed up</p></div>
<div class="paragraph"><p>BLOCKCLONE_SAVE_MBR_DEV="/dev/sdc"                       # Device where partitioning information is stored (optional)
BLOCKCLONE_MBR_FILE="alien_boot_strap.img"               # Output filename for boot strap code
BLOCKCLONE_PARTITIONS_CONF_FILE="alien_partitions.conf"  # Output filename for partition configuration
BLOCKCLONE_ALLOW_MOUNTED="yes"                           # Device can be mounted during backup (default NO)
```</p></div>
</div>
<div class="sect3">
<h4 id="_running_backup">4.8.2. Running backup</h4>
<div class="ulist"><ul>
<li>
<p>
Save partitions configuration, bootstrap code and create actual backup of /dev/sdc1
</p>
</li>
</ul></div>
<div class="paragraph"><p>```
# rear -C alien mkbackuponly
```</p></div>
<div class="ulist"><ul>
<li>
<p>
Running restore from ReaR restore/recovery system
</p>
</li>
</ul></div>
<div class="paragraph"><p>```
# rear -C alien restoreonly</p></div>
<div class="paragraph"><p>Restore alien.dd.img to device: [/dev/sdc1]                 # User is always prompted for restore destination
Device /dev/sdc1 was not found.                             # If destination does not exist ReaR will try to create it (or fail if BLOCKCLONE_SAVE_MBR_DEV was not set during backup)
Restore partition layout to (^c to abort): [/dev/sdc]       # Prompt user for device where partition configuration should be restored
Checking that no-one is using this disk right now &#8230; OK</p></div>
<div class="paragraph"><p>Disk /dev/sdc: 5 GiB, 5368709120 bytes, 10485760 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes</p></div>
<div class="paragraph"><p>&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Created a new DOS disklabel with disk identifier 0x10efb7a9.
Created a new partition 1 of type <em>HPFS/NTFS/exFAT</em> and of size 120 MiB.</p></div>
<div class="paragraph"><p>/dev/sdc2:
New situation:</p></div>
<div class="paragraph"><p>Device     Boot Start    End Sectors  Size Id Type
/dev/sdc1        4096 249855  245760  120M  7 HPFS/NTFS/exFAT</p></div>
<div class="paragraph"><p>The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
```</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_relax_and_recover_with_usb_storage_devices">4.9. Using Relax-and-Recover with USB storage devices</h3>
<div class="paragraph"><p>Using USB devices with Relax-and-Recover can be appealing for several reasons:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you only need to have a bootable rescue environment, a USB device is
   a <strong>cheap device</strong> for storing only 25 to 60MB to boot from
</p>
</li>
<li>
<p>
You can leave the USB device inserted in the system and <strong>opt-in booting</strong>
   from it only when disaster hits (although we do recommend storing rescue
   environments off-site)
</p>
</li>
<li>
<p>
You can <strong>store multiple systems and multiple snapshots</strong> on a single device
</p>
</li>
<li>
<p>
In case you have plenty of space, it might be a simple solution to store
   complete Disaster Recovery images (rescue + backup) on a single device for
   a set of systems
</p>
</li>
<li>
<p>
For migrating a bunch of servers having a single device to boot from might
   be very appealing
</p>
</li>
<li>
<p>
We have implemented a specific workflow: inserting a REAR-000 labeled USB
   stick will invoke <code>rear udev</code> and adds a rescue environment to the USB
   stick (updating the bootloader if needed)
</p>
</li>
</ul></div>
<div class="paragraph"><p>However USB devices may be slow for backup purposes, especially on older
systems or with unreliable/cheap devices.</p></div>
<div class="sect3">
<h4 id="_configuring_relax_and_recover_for_usb_storage_devices">4.9.1. Configuring Relax-and-Recover for USB storage devices</h4>
<div class="paragraph"><p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with USB storage.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>BACULA
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>USB
<span style="color: #009900">USB_DEVICE</span><span style="color: #990000">=</span>/dev/disk/by-label/REAR-<span style="color: #993399">000</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">On RHEL4 or older there are no <em>/dev/disk/by-label/</em> udev aliases,
           which means we cannot use device by label. However it is possible
           to use <code>by-path</code> references, however this makes it very specific
           to the USB port used.  We opted to use the complete device-name,
           which can be dangerous if you may have other <em>/dev/sdX</em> devices
           (luckily we have CCISS block devices in <em>/dev/cciss/</em>).</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_your_usb_storage_device">4.9.2. Preparing your USB storage device</h4>
<div class="paragraph"><p>To prepare your USB device for use with Relax-and-Recover, do: <code>rear format /dev/sdX</code></p></div>
<div class="paragraph"><p>This will create a single partition, make it bootable, format it with ext3,
label it <code>REAR-000</code> and disable warnings related filesystem check for the
device.</p></div>
</div>
<div class="sect3">
<h4 id="_usb_storage_as_rescue_media">4.9.3. USB storage as rescue media</h4>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_to_have_bacula_tools">Configuring Relax-and-Recover to have Bacula tools</h5>
<div class="paragraph"><p>If the rescue environment needs additional tools and workflow, this can be
specified by using <code>BACKUP=BACULA</code> in the configuration file
<em>/etc/rear/local.conf</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>BACULA
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>USB
<span style="color: #009900">USB_DEVICE</span><span style="color: #990000">=</span>/dev/disk/by-label/REAR-<span style="color: #993399">000</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_making_the_rescue_usb_storage_device">Making the rescue USB storage device</h5>
<div class="paragraph"><p>To create a rescue USB device, run <code>rear -v mkrescue</code> as shown below after
you have inserted a <strong>REAR-000</strong> labeled USB device. Make sure the device name
for the USB device is what is configured for <code>USB_DEVICE</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear -v mkrescue
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Creating disk layout.
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Finished in 72 seconds.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Doing the above may replace the existing MBR of the USB device.
         However any other content on the device is retained.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="booting-from-usb">Booting from USB storage device</h5>
<div class="paragraph"><p>Before you can recover our DR backup, it is important to configure the BIOS to
boot from the USB device. In some cases it is required to go into the BIOS setup
(<code>F9</code> during boot) to change the boot-order of devices. (In BIOS setup select
<code>Standard Boot Order (IPL)</code>)</p></div>
<div class="paragraph"><p>Once booted from the USB device, select the system you like to recover from
the list. If you don&#8217;t press a key within 30 seconds, the system will try to
boot from the local disk.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+---------------------------------------------+
|        "Relax-and-Recover v1.12.0svn497"    |
+---------------------------------------------+
|  "Recovery images"                          |
|    "system.localdomain"                   &gt; |
|    "other.localdomain"                    &gt; |
|---------------------------------------------|
|  "Other actions"                            |
|    "Help for Relax-and-Recover"             |
|    "Boot Local disk (hd1)"                  |
|    "Boot BIOS disk (0x81)"                  |
|    "Boot Next BIOS device"                  |
|    "Hardware Detection tool"                |
|    "Memory test"                            |
|    "Reboot system"                          |
|    "Power off system"                       |
+---------------------------------------------+

      "Press [Tab] to edit options or [F1] for help"

           "Automatic boot in 30 seconds..."</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Booting from a local disk may fail when booting from a USB device.
         This is caused by the fact that the GRUB bootloader on the local
         disk is configured as if it is being the first drive <code>(hd0)</code> but
         it is in fact the second disk <code>(hd1)</code>. If you do find menu entries
         not working from GRUB, please remove the <code>root (hd0,0)</code> line from
         the entry.</td>
</tr></table>
</div>
<div class="paragraph"><p>Then select the image you would like to recover.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+---------------------------------------------+
|           "system.localdomain"              |
+---------------------------------------------+
|  "2011-03-26 02:16 backup"                  |
|  "2011-03-25 18:39 backup"                  |
|  "2011-03-05 16:12 rescue image"            |
|---------------------------------------------|
|  "Back"                                     |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
+---------------------------------------------+

      "Press [Tab] to edit options or [F1] for help"


"Backup using kernel 2.6.32-122.el6.x86_64"
"BACKUP=NETFS OUTPUT=USB OUTPUT_URL=usb:///dev/disk/by-label/REAR-000"</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">When browsing through the images you get more information about the
     image at the bottom of the screen.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_restoring_from_usb_rescue_media">Restoring from USB rescue media</h5>
<div class="paragraph"><p>Then wait for the system to boot until you get the prompt.</p></div>
<div class="paragraph"><p>On the shell prompt, type <code>rear recover</code>.</p></div>
<div class="paragraph"><p>You may need to answer a few questions depending on your hardware
configuration and whether you are restoring to a (slightly)
different system.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>RESCUE SYSTEM:/ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
NOTICE: Will do driver migration
To recreate HP SmartArray controller 3, type exactly YES: YES
To recreate HP SmartArray controller 0, type exactly YES: YES
Clearing HP SmartArray controller 3
Clearing HP SmartArray controller 0
Recreating HP SmartArray controller 3|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 0|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Type "Yes" if you want DRBD resource rBCK to become primary: Yes
Type "Yes" if you want DRBD resource rOPS to become primary: Yes
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c2d0 (msdos)
Creating software RAID /dev/md2
Creating software RAID /dev/md6
Creating software RAID /dev/md3
Creating software RAID /dev/md4
Creating software RAID /dev/md5
Creating software RAID /dev/md1
Creating software RAID /dev/md0
Creating LVM PV /dev/md6
Creating LVM PV /dev/md5
Creating LVM PV /dev/md2
Creating LVM VG vgrem
Creating LVM VG vgqry
Creating LVM VG vg00
Creating LVM volume vg00/lv00
Creating LVM volume vg00/lvdstpol
Creating LVM volume vg00/lvsys
Creating LVM volume vg00/lvusr
Creating LVM volume vg00/lvtmp
Creating LVM volume vg00/lvvar
Creating LVM volume vg00/lvopt
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /dstpol on /dev/mapper/vg00-lvdstpol
Mounting filesystem /dstpol
Creating ext3-filesystem /dstpol/sys on /dev/mapper/vg00-lvsys
Mounting filesystem /dstpol/sys
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /boot on /dev/md0
Mounting filesystem /boot
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating swap on /dev/md1
Creating DRBD resource rBCK
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd2
Creating LVM VG vgbck
Creating LVM volume vgbck/lvetc
Creating LVM volume vgbck/lvvar
Creating LVM volume vgbck/lvmysql
Creating ext3-filesystem /etc/bacula/cluster on /dev/mapper/vgbck-lvetc
Mounting filesystem /etc/bacula/cluster
Creating ext3-filesystem /var/bacula on /dev/mapper/vgbck-lvvar
Mounting filesystem /var/bacula
Creating ext3-filesystem /var/lib/mysql/bacula on /dev/mapper/vgbck-lvmysql
Mounting filesystem /var/lib/mysql/bacula
Creating DRBD resource rOPS
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd1
Creating LVM VG vgops
Creating LVM volume vgops/lvcachemgr
Creating LVM volume vgops/lvbackup
Creating LVM volume vgops/lvdata
Creating LVM volume vgops/lvdb
Creating LVM volume vgops/lvswl
Creating LVM volume vgops/lvcluster
Creating ext3-filesystem /opt/cache on /dev/mapper/vgops-lvcachemgr
Mounting filesystem /opt/cache
Creating ext3-filesystem /dstpol/backup on /dev/mapper/vgops-lvbackup
Mounting filesystem /dstpol/backup
Creating ext3-filesystem /dstpol/data on /dev/mapper/vgops-lvdata
Mounting filesystem /dstpol/data
Creating ext3-filesystem /dstpol/databases on /dev/mapper/vgops-lvdb
Mounting filesystem /dstpol/databases
Creating ext3-filesystem /dstpol/swl on /dev/mapper/vgops-lvswl
Mounting filesystem /dstpol/swl
Creating ext3-filesystem /dstpol/sys/cluster on /dev/mapper/vgops-lvcluster
Mounting filesystem /dstpol/sys/cluster
Disk layout created.

The system is now ready to restore from Bacula. You can use the 'bls' command
to get information from your Volume, and 'bextract' to restore jobs from your
Volume. It is assumed that you know what is necessary to restore - typically
it will be a full backup.

You can find useful Bacula commands in the shell history. When finished, type
'exit' in the shell to continue recovery.

WARNING: The new root is mounted under '/mnt/local'.

rear&gt;</code></pre>
</div></div>
</div>
<div class="sect4">
<h5 id="restoring-from-bacula-tape">Restoring from Bacula tape</h5>
<div class="paragraph"><p>Now you need to continue with restoring the actual Bacula backup, for this you
have multiple options of which <code>bextract</code> is the most easy and
straightforward, but also the slowest and unsafest.</p></div>
<div class="paragraph"><p>If you know the JobId of the latest successful full backup, and differential
backups the most efficient way to restore is by creating a bootstrap file with
this information and using it to restore from tape.</p></div>
<div class="paragraph"><p>A bootstrap file looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Volume = VOL-1234
JobId = 914
Job = Bkp_Daily</code></pre>
</div></div>
<div class="paragraph"><p>or</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Volume = VOL-1234
VolSessionId = 1
VolSessionTime = 108927638</code></pre>
</div></div>
<div class="paragraph"><p>Using a bootstrap file with bextract is easy, simply do:
<code>bextract -b bootstrap.txt Ultrium-1 /mnt/local</code></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">It helps to know exactly how many files you need to restore, and using
     the <code>FileIndex</code> and <code>Count</code> keywords so <code>bextract</code> does not require to
     read the whole tape. Use the commands in your shell history to access
     an example Bacula bootstrap file.</td>
</tr></table>
</div>
<div class="paragraph"><p>To use <code>bextract</code> to restore <strong>everything</strong> from a single tape, you can do:
<code>bextract -V VOLUME-NAME Ultrium-1 /mnt/local</code></p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear&gt; bextract -V VOL-1234 Ultrium-1 /mnt/local
bextract: match.c:249-0 add_fname_to_include prefix=0 gzip=0 fname=/
bextract: butil.c:282 Using device: "Ultrium-1" for reading.
30-Mar 16:00 bextract JobId 0: Ready to read from volume "VOL-1234" on device "Ultrium-1" (/dev/st0).
bextract JobId 0: -rw-r-----   1 252      bacula     3623795 2011-03-30 11:02:18  /mnt/local/var/lib/bacula/bacula.sql
bextract JobId 0: drwxr-xr-x   2 root     root          4096 2011-02-02 11:48:28  *none*
bextract JobId 0: drwxr-xr-x   4 root     root          1024 2011-02-23 13:09:53  *none*
bextract JobId 0: drwxr-xr-x  12 root     root          4096 2011-02-02 11:50:00  *none*
bextract JobId 0: -rwx------   1 root     root             0 2011-02-02 11:48:24  /mnt/local/.hpshm_keyfile
bextract JobId 0: -rw-r--r--   1 root     root             0 2011-02-22 12:38:03  /mnt/local/.autofsck
...
30-Mar 16:06 bextract JobId 0: End of Volume at file 7 on device "Ultrium-1" (/dev/st0), Volume "VOL-1234"
30-Mar 16:06 bextract JobId 0: End of all volumes.
30-Mar 16:07 bextract JobId 0: Alert: smartctl version 5.38 [x86_64-redhat-linux-gnu] Copyright (C) 2002-8 Bruce Allen
30-Mar 16:07 bextract JobId 0: Alert: Home page is http://smartmontools.sourceforge.net/
30-Mar 16:07 bextract JobId 0: Alert:
30-Mar 16:07 bextract JobId 0: Alert: TapeAlert: OK
30-Mar 16:07 bextract JobId 0: Alert:
30-Mar 16:07 bextract JobId 0: Alert: Error counter log:
30-Mar 16:07 bextract JobId 0: Alert:            Errors Corrected by           Total   Correction     Gigabytes    Total
30-Mar 16:07 bextract JobId 0: Alert:                ECC          rereads/    errors   algorithm      processed    uncorrected
30-Mar 16:07 bextract JobId 0: Alert:            fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors
30-Mar 16:07 bextract JobId 0: Alert: read:       1546        0         0         0       1546          0.000           0
30-Mar 16:07 bextract JobId 0: Alert: write:         0        0         0         0          0          0.000           0
165719 files restored.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">In this case <code>bextract</code> will restore all the Bacula jobs on the
         provided tapes, start from the oldest, down to the latest. As a
         consequence, deleted files may re-appear and the process may take
         a very long time.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_finish_recovery_process">Finish recovery process</h5>
<div class="paragraph"><p>Once finished, continue Relax-and-Recover by typing <code>exit</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear&gt; exit
Did you restore the backup to /mnt/local ? Ready to continue ? y
Installing GRUB boot loader

Finished recovering your system. You can explore it under '/mnt/local'.

Finished in 4424 seconds.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you neglect to perform this last crucial step, your new system
           will not boot and you have to install a boot-loader yourself
           manually, or re-execute this procedure.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usb_storage_as_backup_media">4.9.4. USB storage as backup media</h4>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_for_backup_to_usb_storage_device">Configuring Relax-and-Recover for backup to USB storage device</h5>
<div class="paragraph"><p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with USB storage.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>USB
<span style="color: #009900">USB_DEVICE</span><span style="color: #990000">=</span>/dev/disk/by-label/REAR-<span style="color: #993399">000</span>

<span style="font-style: italic"><span style="color: #9A1900">### Exclude certain items</span></span>
<span style="color: #009900">ONLY_INCLUDE_VG</span><span style="color: #990000">=(</span> vg00 <span style="color: #990000">)</span>
<span style="color: #009900">EXCLUDE_MOUNTPOINTS</span><span style="color: #990000">=(</span> /data <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_making_the_dr_backup_to_usb_storage_device">Making the DR backup to USB storage device</h5>
<div class="paragraph"><p>Creating a combined rescue device that integrates the backup on USB, it is
sufficient to run <code>rear -v mkbackup</code> as shown below after you have inserted
the USB device. Make sure the device name for the USB device is what is
configured.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear -v mkbackup
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Creating disk layout.
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Creating archive 'usb:///dev/sda1/system.localdomain/20110326.0216/backup.tar.gz'
Total bytes written: 3644416000 (3.4GiB, 5.5MiB/s) in 637 seconds.
Writing MBR to /dev/sda
Modifying local GRUB configuration
Copying resulting files to usb location
Finished in 747 seconds.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">It is advised to go into single user mode (<code>init 1</code>) before creating
           a backup to ensure all active data is consistent on disk (and no
           important processes are active in memory)</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_booting_from_usb_storage_device">Booting from USB storage device</h5>
<div class="paragraph"><p>See the section <a href="#booting-from-usb">Booting from USB storage device</a> for more
information about how to enable your BIOS to boot from a USB storage device.</p></div>
</div>
<div class="sect4">
<h5 id="_restoring_a_backup_from_usb_storage_device">Restoring a backup from USB storage device</h5>
<div class="paragraph"><p>Then wait for the system to boot until you get the prompt.</p></div>
<div class="paragraph"><p>On the shell prompt, type <code>rear recover</code>.</p></div>
<div class="paragraph"><p>You may need to answer a few questions depending on your hardware
configuration and whether you are restoring to a (slightly)
different system.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>RESCUE SYSTEM:/ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Backup archive size is 1.2G (compressed)
To recreate HP SmartArray controller 1, type exactly YES: YES
To recreate HP SmartArray controller 7, type exactly YES: YES
Clearing HP SmartArray controller 1
Clearing HP SmartArray controller 7
Recreating HP SmartArray controller 1|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 7|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c1d0 (msdos)
Creating software RAID /dev/md126
Creating software RAID /dev/md127
Creating LVM PV /dev/md127
Restoring LVM VG vg00
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /boot on /dev/md126
Mounting filesystem /boot
Creating ext3-filesystem /data on /dev/mapper/vg00-lvdata
Mounting filesystem /data
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating swap on /dev/mapper/vg00-lvswap
Disk layout created.
Restoring from 'usb:///dev/sda1/system.localdomain/20110326.0216/backup.tar.gz'
Restored 3478 MiB in 134 seconds [avg 26584 KiB/sec]
Installing GRUB boot loader

Finished recovering your system. You can explore it under '/mnt/local'.

Finished in 278 seconds.</code></pre>
</div></div>
<div class="paragraph"><p>If all is well, you can now remove the USB device, restore the BIOS boot order
and reboot the system into the recovered OS.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_relax_and_recover_with_obdr_tapes">4.10. Using Relax-and-Recover with OBDR tapes</h3>
<div class="paragraph"><p>Using One-Button-Disaster-Recovery (OBDR) tapes has a few benefits.</p></div>
<div class="ulist"><ul>
<li>
<p>
Within large organisations tape media is already <strong>part of a workflow</strong>
   for offsite storage and is a <strong>known and trusted technology</strong>
</p>
</li>
<li>
<p>
Tapes can store large amounts of data reliably and restoring large
   amounts of data is <strong>predictable</strong> in time and effort
</p>
</li>
<li>
<p>
OBDR offers <strong>booting from tapes</strong>, which is very convenient
</p>
</li>
<li>
<p>
A single tape can hold both the rescue image as well as a <strong>complete
   snapshot</strong> of the system (up to 1.6TB with LTO4)
</p>
</li>
</ul></div>
<div class="paragraph"><p>However, you need one tape per system as an OBDR tape can only store one
single rescue environment.</p></div>
<div class="sect3">
<h4 id="_configuring_relax_and_recover_for_obdr_rescue_tapes">4.10.1. Configuring Relax-and-Recover for OBDR rescue tapes</h4>
<div class="paragraph"><p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with a tape drive. This
example shows how to use the tape <strong>only</strong> for storing the rescue image,
the backup is expected to be handled by Bacula and so the Bacula tools
are included in the rescue environment to enable a Bacula restore.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>OBDR
<span style="color: #009900">TAPE_DEVICE</span><span style="color: #990000">=</span>/dev/nst<span style="color: #993399">0</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_preparing_your_obdr_rescue_tape">4.10.2. Preparing your OBDR rescue tape</h4>
<div class="paragraph"><p>To protect normal backup tapes (in case tape drives are also used by another
backup solution) Relax-and-Recover expects that the tape to use is labeled
<strong>REAR-000</strong>.  To achieve this is to insert a blank tape to use for
Relax-and-Recover and run the <code>rear format /dev/stX</code> command.</p></div>
</div>
<div class="sect3">
<h4 id="_obdr_tapes_as_rescue_media">4.10.3. OBDR tapes as rescue media</h4>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_to_have_bacula_tools_2">Configuring Relax-and-Recover to have Bacula tools</h5>
<div class="paragraph"><p>If the rescue environment needs additional tools and workflow, this can be
spcified by using <code>BACKUP=BACULA</code> in the configuration file
<em>/etc/rear/local.conf</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>BACULA
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>OBDR
<span style="color: #009900">BEXTRACT_DEVICE</span><span style="color: #990000">=</span>Ultrium-<span style="color: #993399">1</span>
<span style="color: #009900">BEXTRACT_VOLUME</span><span style="color: #990000">=</span>VOL-<span style="color: #990000">*</span></tt></pre></div></div>
<div class="paragraph"><p>Using the <code>BEXTRACT_DEVICE</code> allows you to use the tape device that is
referenced from the Bacula configuration. This helps in those cases where the
discovery of the various tape drives has already been done and configured in
Bacula.</p></div>
<div class="paragraph"><p>The <code>BEXTRACT_VOLUME</code> variable is optional and is only displayed in the
restore instructions on screen as an aid during recovery.</p></div>
</div>
<div class="sect4">
<h5 id="_making_the_obdr_rescue_tape">Making the OBDR rescue tape</h5>
<div class="paragraph"><p>To create a rescue environment that can boot from an OBDR tape, simply run
<code>rear -v mkrescue</code> with a <strong>REAR-000</strong> -labeled tape inserted.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear -v mkrescue
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Rewinding tape
Writing OBDR header to tape in drive '/dev/nst0'
Creating disk layout.
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-dag-ops.iso (48M)
Writing ISO image to tape
Modifying local GRUB configuration
Finished in 119 seconds.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">The message above about <em>/dev/cciss/c1d0</em> not being used makes sense
as this is not a real disk but simply an entry for manipulating the controller.
This is specific to CCISS controllers with only a tape device attached.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="booting-from-obdr">Booting from OBDR rescue tape</h5>
<div class="paragraph"><p>The One Button Disaster Recovery (OBDR) functionality in HP LTO Ultrium drives
enables them to emulate CD-ROM devices in specific circumstances (also known
as being in <em>'Disaster Recovery</em>' mode). The drive can then act as a boot
device for PCs that support booting off CD-ROM.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">An OBDR capable drive can be switched into CD-ROM mode by <strong>powering on
     with the eject button held down</strong>. Make sure you keep it pressed when the
     tape drive regains power, and then release the button. If the drive is in
     OBDR mode, the light will blink regularly. This might be easier in some
     cases than the below procedure, hence the name One Button Disaster
     Recovery !</td>
</tr></table>
</div>
<div class="paragraph"><p>To boot from OBDR, boot your system with the Relax-and-Recover tape inserted.
During the boot sequence, interrupt the HP Smart Array controller with the
tape attached by pressing <strong>F8</strong> (or <strong>Escape-8</strong> on serial console).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>iLO 2 v1.78 Jun 10 2009 10.5.20.171

Slot 0 HP Smart Array P410i Controller       (512MB, v2.00)   1 Logical Drive
Slot 3 HP Smart Array P401 Controller        (512MB, v2.00)   1 Logical Drive
Slot 4 HP Smart Array P212 Controller          (0MB, v2.00)   0 Logical Drives
     Tape or CD-ROM Drive(s) Detected:
         Port 1I: Box 0: Bay 4
1785-Slot 4 Drive Array Not Configured
     No Drives Detected


  Press &lt;F8&gt; to run the Option ROM Configuration for Arrays Utility
  Press &lt;ESC&gt; to skip configuration and continue</code></pre>
</div></div>
<div class="paragraph"><p>Then select <strong>Configure OBDR</strong> in the menu and select the Tape drive by marking
it with <strong>X</strong> (default is on) and press <strong>ENTER</strong> and <strong>F8</strong> to activate this change
so it displays <em>'Configuration saved</em>'.</p></div>
<div class="paragraph"><p>Then press <strong>ENTER</strong> and <strong>Escape</strong> to leave the Smart Array controller BIOS.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** System will boot from Tape/CD/OBDR device attached to Smart Array.</code></pre>
</div></div>
<div class="paragraph"><p>To boot from OBDR when using an LSI controller, boot your system with the
Relax-and-Recover tape inserted. During the boot sequence, interrupt the
LSI controller BIOS that has the tape attached by pressing <strong>F8</strong> (or
<strong>Escape-8</strong> on serial console).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>LSI Logic Corp. MPT BIOS
Copyright 1995-2006 LSI Logic Corp.
MPTBIOS-5.05.21.00
HP Build

&lt;&lt;&lt;Press F8 for configuration options&gt;&gt;&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Then select the option <code>1. Tape-based One Button Disaster Recovery (OBDR).</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Select a configuration option:
1. Tape-based One Button Disaster Recovery (OBDR).
2. Multi Initiator Configuration.                                 &lt;F9 = Setup&gt;
3. Exit.</code></pre>
</div></div>
<div class="paragraph"><p>And then select the correct tape drive to boot from:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   compatible tape drives found       -&gt;
   NUM   HBA   SCSI ID   Drive information
    0     0       A       - HP       Ultrium 2-SCSI

   Please choose the NUM of the tape drive to place into OBDR mode.</code></pre>
</div></div>
<div class="paragraph"><p>If all goes well, the system will reboot with OBDR-mode enabled:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    The PC will now reboot to begin Tape Recovery....</code></pre>
</div></div>
<div class="paragraph"><p>During the next boot, OBDR-mode will be indicate by:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** Bootable media located, Using non-Emulation mode ***</code></pre>
</div></div>
<div class="paragraph"><p>Once booted from the OBDR tape, select the <em>Relax-and-Recover</em> menu entry from
the menu. If you don&#8217;t press a key within 30 seconds, the system will try to
boot from the local disk.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+---------------------------------------------+
|        "Relax-and-Recover v1.12.0svn497"    |
+---------------------------------------------+
|  "Relax-and-Recover"                        |
|---------------------------------------------|
|  "Other actions"                            |
|    "Help for Relax-and-Recover"             |
|    "Boot Local disk (hd1)"                  |
|    "Boot BIOS disk (0x81)"                  |
|    "Boot Next BIOS device"                  |
|    "Hardware Detection tool"                |
|    "Memory test"                            |
|    "Reboot system"                          |
|    "Power off system"                       |
|                                             |
|                                             |
+---------------------------------------------+

      "Press [Tab] to edit options or [F1] for help"

           "Automatic boot in 30 seconds..."</code></pre>
</div></div>
</div>
<div class="sect4">
<h5 id="_restoring_the_obdr_rescue_tape">Restoring the OBDR rescue tape</h5>
<div class="paragraph"><p>Then wait for the system to boot until you get the prompt.</p></div>
<div class="paragraph"><p>On the shell prompt, type <code>rear recover</code>.</p></div>
<div class="paragraph"><p>You may need to answer a few questions depending on your hardware
configuration and whether you are restoring to a (slightly)
different system.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>RESCUE SYSTEM:/ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
NOTICE: Will do driver migration
Rewinding tape
To recreate HP SmartArray controller 3, type exactly YES: YES
To recreate HP SmartArray controller 0, type exactly YES: YES
Clearing HP SmartArray controller 3
Clearing HP SmartArray controller 0
Recreating HP SmartArray controller 3|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 0|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Type "Yes" if you want DRBD resource rBCK to become primary: Yes
Type "Yes" if you want DRBD resource rOPS to become primary: Yes
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c2d0 (msdos)
Creating software RAID /dev/md2
Creating software RAID /dev/md6
Creating software RAID /dev/md3
Creating software RAID /dev/md4
Creating software RAID /dev/md5
Creating software RAID /dev/md1
Creating software RAID /dev/md0
Creating LVM PV /dev/md6
Creating LVM PV /dev/md5
Creating LVM PV /dev/md2
Creating LVM VG vgrem
Creating LVM VG vgqry
Creating LVM VG vg00
Creating LVM volume vg00/lv00
Creating LVM volume vg00/lvdstpol
Creating LVM volume vg00/lvsys
Creating LVM volume vg00/lvusr
Creating LVM volume vg00/lvtmp
Creating LVM volume vg00/lvvar
Creating LVM volume vg00/lvopt
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /dstpol on /dev/mapper/vg00-lvdstpol
Mounting filesystem /dstpol
Creating ext3-filesystem /dstpol/sys on /dev/mapper/vg00-lvsys
Mounting filesystem /dstpol/sys
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /boot on /dev/md0
Mounting filesystem /boot
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating swap on /dev/md1
Creating DRBD resource rBCK
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd2
Creating LVM VG vgbck
Creating LVM volume vgbck/lvetc
Creating LVM volume vgbck/lvvar
Creating LVM volume vgbck/lvmysql
Creating ext3-filesystem /etc/bacula/cluster on /dev/mapper/vgbck-lvetc
Mounting filesystem /etc/bacula/cluster
Creating ext3-filesystem /var/bacula on /dev/mapper/vgbck-lvvar
Mounting filesystem /var/bacula
Creating ext3-filesystem /var/lib/mysql/bacula on /dev/mapper/vgbck-lvmysql
Mounting filesystem /var/lib/mysql/bacula
Creating DRBD resource rOPS
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd1
Creating LVM VG vgops
Creating LVM volume vgops/lvcachemgr
Creating LVM volume vgops/lvbackup
Creating LVM volume vgops/lvdata
Creating LVM volume vgops/lvdb
Creating LVM volume vgops/lvswl
Creating LVM volume vgops/lvcluster
Creating ext3-filesystem /opt/cache on /dev/mapper/vgops-lvcachemgr
Mounting filesystem /opt/cache
Creating ext3-filesystem /dstpol/backup on /dev/mapper/vgops-lvbackup
Mounting filesystem /dstpol/backup
Creating ext3-filesystem /dstpol/data on /dev/mapper/vgops-lvdata
Mounting filesystem /dstpol/data
Creating ext3-filesystem /dstpol/databases on /dev/mapper/vgops-lvdb
Mounting filesystem /dstpol/databases
Creating ext3-filesystem /dstpol/swl on /dev/mapper/vgops-lvswl
Mounting filesystem /dstpol/swl
Creating ext3-filesystem /dstpol/sys/cluster on /dev/mapper/vgops-lvcluster
Mounting filesystem /dstpol/sys/cluster
Disk layout created.

The system is now ready to restore from Bacula. You can use the 'bls' command
to get information from your Volume, and 'bextract' to restore jobs from your
Volume. It is assumed that you know what is necessary to restore - typically
it will be a full backup.

You can find useful Bacula commands in the shell history. When finished, type
'exit' in the shell to continue recovery.

WARNING: The new root is mounted under '/mnt/local'.

rear&gt;</code></pre>
</div></div>
</div>
<div class="sect4">
<h5 id="_restoring_from_bacula_tape">Restoring from Bacula tape</h5>
<div class="paragraph"><p>See the section <a href="#restoring-from-bacula-tape">Restoring from Bacula tape</a>
for more information about how to restore a Bacula tape.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_obdr_tapes_as_backup_media">4.10.4. OBDR tapes as backup media</h4>
<div class="paragraph"><p>An OBDR backup tape is similar to an OBDR rescue tape, but next to the rescue
environment, it also consists of a complete backup of the system. This is
very convenient in that a single tape can be use for disaster recovery, and
recovery is much more simple and completely automated.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">Please make sure that the system fits onto a single tape uncompressed.
         For an LTO4 Ultrium that would mean no more than 1.6TB.</td>
</tr></table>
</div>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_for_obdr_backup_tapes">Configuring Relax-and-Recover for OBDR backup tapes</h5>
<div class="paragraph"><p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with a tape drive. This example
shows how to use the tape for storing <strong>both</strong> the rescue image and the backup.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>OBDR
<span style="color: #009900">TAPE_DEVICE</span><span style="color: #990000">=</span>/dev/nst<span style="color: #993399">0</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_making_the_obdr_backup_tape">Making the OBDR backup tape</h5>
<div class="paragraph"><p>To create a bootable backup tape that can boot from OBDR, simply run
<code>rear -v mkbackup</code> with a <strong>REAR-000</strong> -labeled tape inserted.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear -v mkbackup
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Rewinding tape
Writing OBDR header to tape in drive '/dev/nst0'
Creating disk layout
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-system.iso (45M)
Writing ISO image to tape
Creating archive '/dev/nst0'
Total bytes written: 7834132480 (7.3GiB, 24MiB/s) in 317 seconds.
Rewinding tape
Modifying local GRUB configuration
Finished in 389 seconds.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">It is advised to go into single user mode (<code>init 1</code>) before creating
           a backup to ensure all active data is consistent on disk (and no
           important processes are active in memory)</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_booting_from_obdr_backup_tape">Booting from OBDR backup tape</h5>
<div class="paragraph"><p>See the section <a href="#booting-from-obdr">Booting from OBDR rescue tape</a> for more
information about how to enable OBDR and boot from OBDR tapes.</p></div>
</div>
<div class="sect4">
<h5 id="_restoring_from_obdr_backup_tape">Restoring from OBDR backup tape</h5>
<div class="listingblock">
<div class="content">
<pre><code>RESCUE SYSTEM:~ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
NOTICE: Will do driver migration
Rewinding tape
To recreate HP SmartArray controller 3, type exactly YES: YES
To recreate HP SmartArray controller 0, type exactly YES: YES
Clearing HP SmartArray controller 3
Clearing HP SmartArray controller 0
Recreating HP SmartArray controller 3|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 0|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Type "Yes" if you want DRBD resource rBCK to become primary: Yes
Type "Yes" if you want DRBD resource rOPS to become primary: Yes
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c2d0 (msdos)
Creating software RAID /dev/md2
Creating software RAID /dev/md6
Creating software RAID /dev/md3
Creating software RAID /dev/md4
Creating software RAID /dev/md5
Creating software RAID /dev/md1
Creating software RAID /dev/md0
Creating LVM PV /dev/md6
Creating LVM PV /dev/md5
Creating LVM PV /dev/md2
Restoring LVM VG vgrem
Restoring LVM VG vgqry
Restoring LVM VG vg00
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /dstpol on /dev/mapper/vg00-lvdstpol
Mounting filesystem /dstpol
Creating ext3-filesystem /dstpol/sys on /dev/mapper/vg00-lvsys
Mounting filesystem /dstpol/sys
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /boot on /dev/md0
Mounting filesystem /boot
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating swap on /dev/md1
Creating DRBD resource rBCK
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd2
Restoring LVM VG vgbck
Creating ext3-filesystem /etc/bacula/cluster on /dev/mapper/vgbck-lvetc
Mounting filesystem /etc/bacula/cluster
Creating ext3-filesystem /var/bacula on /dev/mapper/vgbck-lvvar
Mounting filesystem /var/bacula
Creating ext3-filesystem /var/lib/mysql/bacula on /dev/mapper/vgbck-lvmysql
Mounting filesystem /var/lib/mysql/bacula
Creating DRBD resource rOPS
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd1
Restoring LVM VG vgops
Creating ext3-filesystem /opt/cache on /dev/mapper/vgops-lvcachemgr
Mounting filesystem /opt/cache
Creating ext3-filesystem /dstpol/backup on /dev/mapper/vgops-lvbackup
Mounting filesystem /dstpol/backup
Creating ext3-filesystem /dstpol/data on /dev/mapper/vgops-lvdata
Mounting filesystem /dstpol/data
Creating ext3-filesystem /dstpol/databases on /dev/mapper/vgops-lvdb
Mounting filesystem /dstpol/databases
Creating ext3-filesystem /dstpol/swl on /dev/mapper/vgops-lvswl
Mounting filesystem /dstpol/swl
Creating ext3-filesystem /dstpol/sys/cluster on /dev/mapper/vgops-lvcluster
Mounting filesystem /dstpol/sys/cluster
Disk layout created.
Restoring from 'tape:///dev/nst0/system/backup.tar'
Restored 7460 MiB in 180 seconds [avg 42444 KiB/sec]
Installing GRUB boot loader

Finished recovering your system. You can explore it under '/mnt/local'.

Finished in 361 seconds.</code></pre>
</div></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration">5. Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_monitoring_your_system_with_relax_and_recover">5.1. Monitoring your system with Relax-and-Recover</h3>
<div class="paragraph"><p>If Relax-and-Recover is not in charge of the backup, but only for creating
a rescue environment, it can be useful to know when a change to the system
invalidates your existing/stored rescue environment, requiring one to update
the rescue environment.</p></div>
<div class="paragraph"><p>For this, Relax-and-Recover has two different targets, one to create a new
baseline (which is automatically done when creating a new rescue environment
successfully. And one to verify the (old) baseline to the current situation.</p></div>
<div class="paragraph"><p>With this, one can monitor or automate generating new rescue environments only
when it is really needed.</p></div>
<div class="sect3">
<h4 id="_creating_a_baseline">5.1.1. Creating a baseline</h4>
<div class="paragraph"><p>Relax-and-Recover automatically creates a new baseline as soon as it
successfully has created a new rescue environment. However if for some reason
you want to recreate the baseline manually, use <code>rear savelayout</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_detecting_changes_to_the_baseline">5.1.2. Detecting changes to the baseline</h4>
<div class="paragraph"><p>When you want to know if the latest rescue environment is still valid, you may
want to use the <code>rear checklayout</code> command instead.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear checklayout
[root@system ~]# echo $?
0</code></pre>
</div></div>
<div class="paragraph"><p>If the layout has changed, the return code will indicate this by a non-zero
return code.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[root@system ~]# rear checklayout
[root@system ~]# echo $?
1</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_integration_with_nagios_and_opsview">5.1.3. Integration with Nagios and Opsview</h4>
<div class="paragraph"><p>If having current DR rescue images is important to your organization, but they
cannot be automated (eg. a tape or USB device needs inserting), we provide a
Nagios plugin that can send out a notification whenever there is a critical
change to the system that requires updating your rescue environment.</p></div>
<div class="paragraph"><p>Changes to the system requiring an update are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Changes to hardware RAID
</p>
</li>
<li>
<p>
Changes to software RAID
</p>
</li>
<li>
<p>
Changes to partitioning
</p>
</li>
<li>
<p>
Changes to DRBD configuration
</p>
</li>
<li>
<p>
Changes to LVM
</p>
</li>
<li>
<p>
Changes to filesystems
</p>
</li>
</ul></div>
<div class="paragraph"><p>The integration is done using our own <em>check_rear</em> plugin for Nagios.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#!/bin/bash</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Purpose: Checks if disaster recovery usb stick is up to date</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Check if ReaR is installed</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">[[</span> <span style="color: #990000">!</span> -x /usr/sbin/rear <span style="color: #990000">]];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    echo <span style="color: #FF0000">"REAR IS NOT INSTALLED"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #993399">2</span>
<span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># ReaR disk layout status can be identical or changed</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># returncode: 0 = ok</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> /usr/sbin/rear checklayout<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    echo <span style="color: #FF0000">"Disk layout has changed. Please insert Disaster Recovery USB stick into system !"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #993399">2</span>
<span style="font-weight: bold"><span style="color: #0000FF">fi</span></span></tt></pre></div></div>
<div class="paragraph"><p>We also monitor the <em>/var/log/rear/rear-system.log</em> file for <code>ERROR:</code> and <code>BUG BUG BUG</code>
strings, so that in case of problems the operator is notified immediately.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_layout_configuration">6. Layout configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>Jeroen Hoekx &lt;<a href="mailto:jeroen.hoekx@hamok.be">jeroen.hoekx@hamok.be</a>&gt;
2011-09-10</p></div>
<div class="sect2">
<h3 id="_general_overview">6.1. General overview</h3>
<div class="paragraph"><p>The disk layout generation code in Relax-and-Recover is responsible for the
faithful recreation of the disk layout of the original system. It gathers
information about any component in the system layout. Components supported in
Relax-and-Recover include:</p></div>
<div class="ulist"><ul>
<li>
<p>
Partitions
</p>
</li>
<li>
<p>
Logical volume management (LVM)
</p>
</li>
<li>
<p>
Software RAID (MD)
</p>
</li>
<li>
<p>
Encrypted volumes (LUKS)
</p>
</li>
<li>
<p>
Multipath disks
</p>
</li>
<li>
<p>
Swap
</p>
</li>
<li>
<p>
Filesystems
</p>
</li>
<li>
<p>
Btrfs Volumes
</p>
</li>
<li>
<p>
DRBD
</p>
</li>
<li>
<p>
HP SmartArray controllers
</p>
</li>
</ul></div>
<div class="paragraph"><p>Relax-and-Recover detects dependencies between these components.</p></div>
<div class="paragraph"><p>During the rescue media creation phase, Relax-and-Recover centralizes all
information in one file. During recovery, that file is used to generate the
actual commands to recreate the components. Relax-and-Recover allows
customizations and manual editing in all these phases.</p></div>
</div>
<div class="sect2">
<h3 id="_layout_information_gathered_during_rescue_image_creation">6.2. Layout information gathered during rescue image creation</h3>
<div class="paragraph"><p>Layout information is stored in <code>/var/lib/rear/layout/disklayout.conf</code>. The term <em>layout file</em> in this document refers to this particular file.</p></div>
<div class="paragraph"><p>Consider the information from the following system as an example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>disk /dev/sda 160041885696 msdos
# disk /dev/sdb 320072933376 msdos
# disk /dev/sdc 1999696297984 msdos
part /dev/sda 209682432 32768 primary boot /dev/sda1
part /dev/sda 128639303680 209719296 primary lvm /dev/sda2
part /dev/sda 31192862720 128849022976 primary none /dev/sda3
# part /dev/sdb 162144912384 32256 primary none /dev/sdb1
# part /dev/sdb 152556666880 162144944640 primary none /dev/sdb2
# part /dev/sdb 5371321856 314701611520 primary boot /dev/sdb3
# part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
# part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
# lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
# lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
# lvmvol /dev/backup backup 12800 104857600
# lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
lvmvol /dev/system vmxfs 7680 62914560
lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sda1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sda2 cipher=aes mode=xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb</code></pre>
</div></div>
<div class="paragraph"><p>This document will continue to use this example to explore the various options
available in Relax-and-Recover. The exact syntax of the layout file is
described in a later section. It is already clear that this file is human
readable and thus human editable. It is also machine readable and all
information necessary to restore a system is listed.</p></div>
<div class="paragraph"><p>It&#8217;s easy to see that there are 3 disks attached to the system. <code>/dev/sda</code> is the internal disk of the system. Its filesystems are normally mounted. The other devices are external disks. One of them has just normal partitions. The other one has a physical volume on one of the partitions.</p></div>
</div>
<div class="sect2">
<h3 id="_including_excluding_components">6.3. Including/Excluding components</h3>
<div class="sect3">
<h4 id="_autoexcludes">6.3.1. Autoexcludes</h4>
<div class="paragraph"><p>Relax-and-Recover has reasonable defaults when creating the recovery
information. It has commented out the two external disks and any
component that&#8217;s part of it. The reason is that no mounted filesystem
uses these two disks. After all, you don&#8217;t want to recreate your
backup disk when you&#8217;re recovering your system.</p></div>
<div class="paragraph"><p>If we mount the filesystem on <code>/dev/mapper/backup-backup</code> on <code>/media/backup</code>,
Relax-and-Recover will think that it&#8217;s necessary to recreate the filesystem:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>disk /dev/sda 160041885696 msdos
# disk /dev/sdb 320072933376 msdos
disk /dev/sdc 1999696297984 msdos
part /dev/sda 209682432 32768 primary boot /dev/sda1
part /dev/sda 128639303680 209719296 primary lvm /dev/sda2
part /dev/sda 31192862720 128849022976 primary none /dev/sda3
# part /dev/sdb 162144912384 32256 primary none /dev/sdb1
# part /dev/sdb 152556666880 162144944640 primary none /dev/sdb2
# part /dev/sdb 5371321856 314701611520 primary boot /dev/sdb3
part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
lvmvol /dev/backup backup 12800 104857600
lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
lvmvol /dev/system vmxfs 7680 62914560
lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sda1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
fs /dev/mapper/backup-backup /media/backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sda2 cipher=aes mode=xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb</code></pre>
</div></div>
<div class="paragraph"><p>This behavior is controlled by the <code>AUTOEXCLUDE_DISKS=y</code> parameter in
<code>default.conf</code>. If we unset it in the local configuration, Relax-and-Recover
will no longer exclude it automatically.</p></div>
<div class="paragraph"><p>A similar mechanism exists for multipath disks. The <code>AUTOEXCLUDE_MULTIPATH=y</code>
variable in <code>default.conf</code> prevents Relax-and-Recover from overwriting
multipath disks. Typically, they are part of the SAN disaster recovery
strategy. However, there can be cases where you want to recover them. The
information is retained in <code>disklayout.conf</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_manual_excludes">6.3.2. Manual excludes</h4>
<div class="paragraph"><p>It seems prudent to prevent the external drives from ever being backed-up or overwritten. The default configuration contains these lines:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># Exclude components from being backed up, recreation information is active
EXCLUDE_BACKUP=()

# Exclude components during component recreation
# will be added to EXCLUDE_BACKUP (it is not backed up)
# recreation information gathered, but commented out
EXCLUDE_RECREATE=()

# Exclude components during the backup restore phase
# only used to exclude files from the restore.
EXCLUDE_RESTORE=()</code></pre>
</div></div>
<div class="paragraph"><p>To prevent an inadvertently mounted backup filesystem being added to the restore list, the easiest way is to add the filesystem to the <code>EXCLUDE_RECREATE</code> array.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" "fs:/media/backup" )</code></pre>
</div></div>
<div class="paragraph"><p>The layout file is as expected:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>disk /dev/sda 160041885696 msdos
# disk /dev/sdb 320072933376 msdos
# disk /dev/sdc 1999696297984 msdos
part /dev/sda 209682432 32768 primary boot /dev/sda1
part /dev/sda 128639303680 209719296 primary lvm /dev/sda2
part /dev/sda 31192862720 128849022976 primary none /dev/sda3
# part /dev/sdb 162144912384 32256 primary none /dev/sdb1
# part /dev/sdb 152556666880 162144944640 primary none /dev/sdb2
# part /dev/sdb 5371321856 314701611520 primary boot /dev/sdb3
# part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
# part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
# lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
# lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
# lvmvol /dev/backup backup 12800 104857600
# lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
lvmvol /dev/system vmxfs 7680 62914560
lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sda1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
# fs /dev/mapper/backup-backup /media/backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sda2 cipher=aes mode=xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb</code></pre>
</div></div>
<div class="paragraph"><p>Another approach would be to exclude the backup volume group. This is achieved by adding this line to the local configuration:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" "/dev/backup" )</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_restore_to_the_same_hardware">6.4. Restore to the same hardware</h3>
<div class="paragraph"><p>Restoring the system to the same hardware is simple. Type <code>rear recover</code> in
the rescue system prompt. Relax-and-Recover will detect that it&#8217;s restoring to
the same system and will make sure things like UUIDs match. It also asks for
your LUKS encryption password.</p></div>
<div class="paragraph"><p>Once the restore of the backup has completed, Relax-and-Recover will install
the bootloader and the system is back in working order.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>RESCUE firefly:~ # rear recover
Relax-and-Recover 0.0.0 / $Date$
NOTICE: Will do driver migration
Comparing disks.
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/sda (msdos)
Please enter the password for disk(/dev/sda2):
Enter LUKS passphrase:
Please re-enter the password for disk(/dev/sda2):
Enter passphrase for /dev/sda2:
Creating LVM PV /dev/mapper/disk
Restoring LVM VG system
Creating ext4-filesystem / on /dev/mapper/system-root
Mounting filesystem /
Creating ext4-filesystem /home on /dev/mapper/system-home
Mounting filesystem /home
Creating ext4-filesystem /var on /dev/mapper/system-var
Mounting filesystem /var
Creating xfs-filesystem /vmware on /dev/mapper/system-vmxfs
meta-data=/dev/mapper/system-vmxfs isize=256    agcount=4, agsize=1966080 blks
         =                       sectsz=512   attr=2, projid32bit=0
data     =                       bsize=4096   blocks=7864320, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0
log      =internal log           bsize=4096   blocks=3840, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
Mounting filesystem /vmware
Creating ext4-filesystem /kvm on /dev/mapper/system-kvm
Mounting filesystem /kvm
Creating ext3-filesystem /boot on /dev/sda1
Mounting filesystem /boot
Creating swap on /dev/mapper/system-swap
Disk layout created.
Please start the restore process on your backup host.

Make sure that you restore the data into '/mnt/local' instead of '/' because the
hard disks of the recovered system are mounted there.

Please restore your backup in the provided shell and, when finished, type exit
in the shell to continue recovery.

Welcome to Relax-and-Recover. Run "rear recover" to restore your system !

rear&gt;</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_restore_to_different_hardware">6.5. Restore to different hardware</h3>
<div class="paragraph"><p>There are two ways to deal with different hardware. One is being lazy and dealing with problems when you encounter them. The second option is to plan in advance. Both are valid approaches. The lazy approach works fine when you are in control of the restore and you have good knowledge of the components in your system. The second approach is preferable in disaster recovery situations or migrations where you know the target hardware in advance and the actual restore can be carried out by less knowledgeable people.</p></div>
<div class="sect3">
<h4 id="_the_ad_hoc_way">6.5.1. The Ad-Hoc Way</h4>
<div class="paragraph"><p>Relax-and-Recover will assist you somewhat in case it notices different disk
sizes. It will ask you to map each differently sized disk to a disk in the
target system. Partitions will be resized. Relax-and-Recover is careful not to
resize your boot partition, since this is often the one with the most
stringent sizing constraints. In fact, it only resizes LVM and RAID
partitions.</p></div>
<div class="paragraph"><p>Let&#8217;s try to restore our system to a different system. Instead of one 160G
disk, there is now one 5G and one 10G disk. That&#8217;s not enough space to restore
the complete system, but for purposes of this demonstration, we do not care
about that. We&#8217;re also not going to use the first disk, but we just want to
show that Relax-and-Recover handles the renaming automatically.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>RESCUE firefly:~ # rear recover
Relax-and-Recover 0.0.0 / $Date$
NOTICE: Will do driver migration
Comparing disks.
Device sda has size 5242880000, 160041885696 expected
Switching to manual disk layout configuration.
Disk sda does not exist in the target system. Please choose the appropriate replacement.
1) sda
2) sdb
3) Do not map disk.
#? 2
2011-09-10 16:17:10 Disk sdb chosen as replacement for sda.
Disk sdb chosen as replacement for sda.
This is the disk mapping table:
    /dev/sda /dev/sdb
Please confirm that '/var/lib/rear/layout/disklayout.conf' is as you expect.

1) View disk layout (disklayout.conf)  4) Go to Relax-and-Recover shell
2) Edit disk layout (disklayout.conf)  5) Continue recovery
3) View original disk space usage      6) Abort Relax-and-Recover</code></pre>
</div></div>
<div class="paragraph"><p>Ok, mapping the disks was not that hard. If Relax-and-Recover insists on us
checking the disklayout file, we&#8217;d better do that.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#? 1
disk /dev/sdb 160041885696 msdos
# disk _REAR1_ 320072933376 msdos
# disk /dev/sdc 1999696297984 msdos
part /dev/sdb 209682432 32768 primary boot /dev/sdb1
part /dev/sdb -20916822016 209719296 primary lvm /dev/sdb2
part /dev/sdb 31192862720 128849022976 primary none /dev/sdb3
# part _REAR1_ 162144912384 32256 primary none _REAR1_1
# part _REAR1_ 152556666880 162144944640 primary none _REAR1_2
# part _REAR1_ 5371321856 314701611520 primary boot _REAR1_3
# part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
# part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
# lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
# lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
# lvmvol /dev/backup backup 12800 104857600
# lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
lvmvol /dev/system vmxfs 7680 62914560
lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sdb1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
# fs /dev/mapper/backup-backup /media/backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sdb2 cipher=aes mode=xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb

1) View disk layout (disklayout.conf)
2) Edit disk layout (disklayout.conf)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#?</code></pre>
</div></div>
<div class="paragraph"><p>The renaming operation was successful.</p></div>
<div class="paragraph"><p>On the other hand, we can already see quite a few problems. A partition with negative sizes. I do not think any tool would like to create that. Still, we don&#8217;t care at this moment. Do you like entering partition sizes in bytes? Neither do I. There has to be a better way to handle it. We will show it during the next step.</p></div>
<div class="paragraph"><p>The /kvm and /vmware filesystems are quite big. We don&#8217;t care about them, so just put some nice comments on them and their logical volumes.</p></div>
<div class="paragraph"><p>The resulting layout file looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>disk /dev/sdb 160041885696 msdos
# disk _REAR1_ 320072933376 msdos
# disk /dev/sdc 1999696297984 msdos
part /dev/sdb 209682432 32768 primary boot /dev/sdb1
part /dev/sdb -20916822016 209719296 primary lvm /dev/sdb2
part /dev/sdb 31192862720 128849022976 primary none /dev/sdb3
# part _REAR1_ 162144912384 32256 primary none _REAR1_1
# part _REAR1_ 152556666880 162144944640 primary none _REAR1_2
# part _REAR1_ 5371321856 314701611520 primary boot _REAR1_3
# part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
# part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
# lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
# lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
# lvmvol /dev/backup backup 12800 104857600
# lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
#lvmvol /dev/system vmxfs 7680 62914560
#lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
#fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
#fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sdb1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
# fs /dev/mapper/backup-backup /media/backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sdb2 cipher=aes mode=xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s continue recovery.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>1) View disk layout (disklayout.conf)
2) Edit disk layout (disklayout.conf)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#? 5
Partition /dev/sdb3 size reduced to fit on disk.
Please confirm that '/var/lib/rear/layout/diskrestore.sh' is as you expect.

1) View restore script (diskrestore.sh)
2) Edit restore script (diskrestore.sh)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#?</code></pre>
</div></div>
<div class="paragraph"><p>Now, this is where human friendly resizes are possible. Edit the file. Find the partition creation code.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)
LogPrint "Creating partitions for disk /dev/sdb (msdos)"
parted -s /dev/sdb mklabel msdos &gt;&amp;2
parted -s /dev/sdb mkpart primary 32768B 209715199B &gt;&amp;2
parted -s /dev/sdb set 1 boot on &gt;&amp;2
parted -s /dev/sdb mkpart primary 209719296B -20707102721B &gt;&amp;2
parted -s /dev/sdb set 2 lvm on &gt;&amp;2
parted -s /dev/sdb mkpart primary 18446744053002452992B 10485759999B &gt;&amp;2
# Wait some time before advancing
sleep 10</code></pre>
</div></div>
<div class="paragraph"><p>It&#8217;s simple bash code. Change it to use better values. Parted is happy to accept partitions in Megabytes.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)
LogPrint "Creating partitions for disk /dev/sdb (msdos)"
parted -s /dev/sdb mklabel msdos &gt;&amp;2
parted -s /dev/sdb mkpart primary 1M 200M &gt;&amp;2
parted -s /dev/sdb set 1 boot on &gt;&amp;2
parted -s /dev/sdb mkpart primary 200M 10485759999B &gt;&amp;2
parted -s /dev/sdb set 2 lvm on &gt;&amp;2
# Wait some time before advancing
sleep 10</code></pre>
</div></div>
<div class="paragraph"><p>The same action should be done for the remaining logical volumes. We would like them to fit on the disk.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>if create_component "/dev/mapper/system-root" "lvmvol" ; then
# Create /dev/mapper/system-root (lvmvol)
LogPrint "Creating LVM volume system/root"
lvm lvcreate -l 2560 -n root system &gt;&amp;2
component_created "/dev/mapper/system-root" "lvmvol"
else
    LogPrint "Skipping /dev/mapper/system-root (lvmvol) as it has already been created."
fi</code></pre>
</div></div>
<div class="paragraph"><p>No-one but a computer likes to think in extents, so we size it a comfortable 5G.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>if create_component "/dev/mapper/system-root" "lvmvol" ; then
# Create /dev/mapper/system-root (lvmvol)
LogPrint "Creating LVM volume system/root"
lvm lvcreate -L 5G -n root system &gt;&amp;2
component_created "/dev/mapper/system-root" "lvmvol"
else
    LogPrint "Skipping /dev/mapper/system-root (lvmvol) as it has already been created."
fi</code></pre>
</div></div>
<div class="paragraph"><p>Do the same thing for the other logical volumes and choose number 5, continue.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>1) View restore script (diskrestore.sh)
2) Edit restore script (diskrestore.sh)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#? 5
Start system layout restoration.
Creating partitions for disk /dev/sdb (msdos)
Please enter the password for disk(/dev/sdb2):
Enter LUKS passphrase:
Please re-enter the password for disk(/dev/sdb2):
Enter passphrase for /dev/sdb2:
Creating LVM PV /dev/mapper/disk
Creating LVM VG system
Creating LVM volume system/root
Creating LVM volume system/home
Creating LVM volume system/var
Creating LVM volume system/swap
Creating ext4-filesystem / on /dev/mapper/system-root
Mounting filesystem /
Creating ext4-filesystem /home on /dev/mapper/system-home
An error occurred during layout recreation.

1) View Relax-and-Recover log
2) View original disk space usage
3) Go to Relax-and-Recover shell
4) Edit restore script (diskrestore.sh)
5) Continue restore script
6) Abort Relax-and-Recover
#?</code></pre>
</div></div>
<div class="paragraph"><p>An error&#8230; Did you expect it? I didn&#8217;t.</p></div>
<div class="paragraph"><p>Relax-and-Recover produces exceptionally good logs. Let&#8217;s check them.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+++ tune2fs -r 262144 -c 38 -i 180d /dev/mapper/system-home
tune2fs: reserved blocks count is too big (262144)
tune2fs 1.41.14 (22-Dec-2010)
Setting maximal mount count to 38
Setting interval between checks to 15552000 seconds
2011-09-10 16:27:35 An error occurred during layout recreation.</code></pre>
</div></div>
<div class="paragraph"><p>Yes, we resized the home partition from 20GB to 2G in the previous step. The root user wants more reserved blocks than the total number of available blocks.</p></div>
<div class="paragraph"><p>Fixing it is simple. Edit the restore script, option 4. Find the code responsible for filesystem creation.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>if create_component "fs:/home" "fs" ; then
# Create fs:/home (fs)
LogPrint "Creating ext4-filesystem /home on /dev/mapper/system-home"
mkfs -t ext4 -b 4096 /dev/mapper/system-home &gt;&amp;2
tune2fs -U e9310015-6043-48cd-a37d-78dbfdba1e3b /dev/mapper/system-home &gt;&amp;2
tune2fs -r 262144 -c 38 -i 180d /dev/mapper/system-home &gt;&amp;2
LogPrint "Mounting filesystem /home"
mkdir -p /mnt/local/home
mount /dev/mapper/system-home /mnt/local/home
component_created "fs:/home" "fs"
else
    LogPrint "Skipping fs:/home (fs) as it has already been created."
fi</code></pre>
</div></div>
<div class="paragraph"><p>The <code>-r</code> parameter is causing the error. We just remove it and do the same for the other filesystems.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>if create_component "fs:/home" "fs" ; then
# Create fs:/home (fs)
LogPrint "Creating ext4-filesystem /home on /dev/mapper/system-home"
mkfs -t ext4 -b 4096 /dev/mapper/system-home &gt;&amp;2
tune2fs -U e9310015-6043-48cd-a37d-78dbfdba1e3b /dev/mapper/system-home &gt;&amp;2
tune2fs -c 38 -i 180d /dev/mapper/system-home &gt;&amp;2
LogPrint "Mounting filesystem /home"
mkdir -p /mnt/local/home
mount /dev/mapper/system-home /mnt/local/home
component_created "fs:/home" "fs"
else
    LogPrint "Skipping fs:/home (fs) as it has already been created."
fi</code></pre>
</div></div>
<div class="paragraph"><p>Continue the restore script.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>1) View Relax-and-Recover log
2) View original disk space usage
3) Go to Relax-and-Recover shell
4) Edit restore script (diskrestore.sh)
5) Continue restore script
6) Abort Relax-and-Recover
#? 5
Start system layout restoration.
Skipping /dev/sdb (disk) as it has already been created.
Skipping /dev/sdb1 (part) as it has already been created.
Skipping /dev/sdb2 (part) as it has already been created.
Skipping /dev/sdb3 (part) as it has already been created.
Skipping /dev/mapper/disk (crypt) as it has already been created.
Skipping pv:/dev/mapper/disk (lvmdev) as it has already been created.
Skipping /dev/system (lvmgrp) as it has already been created.
Skipping /dev/mapper/system-root (lvmvol) as it has already been created.
Skipping /dev/mapper/system-home (lvmvol) as it has already been created.
Skipping /dev/mapper/system-var (lvmvol) as it has already been created.
Skipping /dev/mapper/system-swap (lvmvol) as it has already been created.
Skipping fs:/ (fs) as it has already been created.
Creating ext4-filesystem /home on /dev/mapper/system-home
Mounting filesystem /home
Creating ext4-filesystem /var on /dev/mapper/system-var
Mounting filesystem /var
Creating ext3-filesystem /boot on /dev/sdb1
Mounting filesystem /boot
Creating swap on /dev/mapper/system-swap
Disk layout created.</code></pre>
</div></div>
<div class="paragraph"><p>That looks the way we want it. Notice how Relax-and-Recover detected that it
had already created quite a few components and did not try to recreate them
anymore.</p></div>
</div>
<div class="sect3">
<h4 id="_planning_in_advance">6.5.2. Planning In Advance</h4>
<div class="paragraph"><p>Relax-and-Recover makes it possible to define the layout on the target system
even before the backup is taken. All one has to do is to move the
<code>/var/lib/rear/layout/disklayout.conf</code> file to <code>/etc/rear/disklayout.conf</code> and
edit it. This won&#8217;t be overwritten on future backup runs. During recovery,
Relax-and-Recover will use that file instead of the snapshot of the original
system.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_disk_layout_file_syntax">6.6. Disk layout file syntax</h3>
<div class="paragraph"><p>This section describes the syntax of all components in the Relax-and-Recover
layout file at <code>/var/lib/rear/layout/disklayout.conf</code>. The syntax used to describe it
is straightforward. Normal text has to be present verbatim in the file. Angle
brackets "&lt;" and "&gt;" delimit a value that can be edited. Quotes " inside the
angle brackets indicate a verbatim option, often used together with a / to
indicate multiple options. Parenthesis "(" ")" inside explain the expected unit. No
unit suffix should be present, unless specifically indicated. Square brackets
"[" and "]" indicate an optional parameter. They can be excluded when
hand-crafting a layout file line.</p></div>
<div class="sect3">
<h4 id="_disks">6.6.1. Disks</h4>
<div class="listingblock">
<div class="content">
<pre><code>disk &lt;name&gt; &lt;size(B)&gt; &lt;partition label&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_partitions">6.6.2. Partitions</h4>
<div class="listingblock">
<div class="content">
<pre><code>part &lt;disk name&gt; &lt;size(B)&gt; &lt;start(B)&gt; &lt;partition name/type&gt; &lt;flags/"none"&gt; &lt;partition name&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_software_raid">6.6.3. Software RAID</h4>
<div class="listingblock">
<div class="content">
<pre><code>raid /dev/&lt;name&gt; level=&lt;RAID level&gt; raid-devices=&lt;nr of devices&gt; [uuid=&lt;uuid&gt;] [spare-devices=&lt;nr of spares&gt;] [layout=&lt;RAID layout&gt;] [chunk=&lt;chunk size&gt;] devices=&lt;device1,device2,...&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_physical_volumes">6.6.4. Physical Volumes</h4>
<div class="listingblock">
<div class="content">
<pre><code>lvmdev /dev/&lt;volume group name&gt; &lt;device&gt; &lt;UUID&gt; [&lt;size(K)&gt;]</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_volume_groups">6.6.5. Volume Groups</h4>
<div class="listingblock">
<div class="content">
<pre><code>lvmgrp /dev/&lt;volume group name&gt; &lt;extent size(B)&gt; [&lt;number of extents&gt;] [&lt;size(K)&gt;]</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_logical_volumes">6.6.6. Logical Volumes</h4>
<div class="listingblock">
<div class="content">
<pre><code>lvmvol /dev/&lt;volume group name&gt; &lt;logical volume name&gt; &lt;number of extents&gt; [&lt;size(K)&gt;]</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_luks_devices">6.6.7. LUKS Devices</h4>
<div class="listingblock">
<div class="content">
<pre><code>crypt /dev/mapper/&lt;name&gt; &lt;device&gt; cipher=&lt;cipher&gt; mode=&lt;cipher mode&gt; hash=&lt;hash function&gt; [uuid=&lt;uuid&gt;]</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_drbd">6.6.8. DRBD</h4>
<div class="listingblock">
<div class="content">
<pre><code>drbd /dev/drbd&lt;nr&gt; &lt;drbd resource name&gt; &lt;device&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_filesystems">6.6.9. Filesystems</h4>
<div class="listingblock">
<div class="content">
<pre><code>fs &lt;device&gt; &lt;mountpoint&gt; &lt;filesystem type&gt; [uuid=&lt;uuid&gt;] [label=&lt;label&gt;] [blocksize=&lt;block size(B)&gt;] [&lt;reserved_blocks=&lt;nr of reserved blocks&gt;] [max_mounts=&lt;nr&gt;] [check_interval=&lt;number of days&gt;d] [options=&lt;filesystem options&gt;]</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_btrfs_default_subvolumes">6.6.10. Btrfs Default SubVolumes</h4>
<div class="listingblock">
<div class="content">
<pre><code>btrfsdefaultsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_btrfs_normal_subvolumes">6.6.11. Btrfs Normal SubVolumes</h4>
<div class="listingblock">
<div class="content">
<pre><code>btrfsnormalsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_btrfs_mounted_subvolumes">6.6.12. Btrfs Mounted SubVolumes</h4>
<div class="listingblock">
<div class="content">
<pre><code>btrfsmountedsubvol &lt;device&gt; &lt;subvolume_mountpoint&gt; &lt;mount_options&gt; &lt;btrfs_subvolume_path&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_swap">6.6.13. Swap</h4>
<div class="listingblock">
<div class="content">
<pre><code>swap &lt;device&gt; [uuid=&lt;uuid&gt;] [label=&lt;label&gt;]</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_hp_smartarray_controllers">6.6.14. HP SmartArray Controllers</h4>
<div class="listingblock">
<div class="content">
<pre><code>smartarray &lt;slot number&gt;</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_hp_smartarray_logical_drives">6.6.15. HP SmartArray Logical Drives</h4>
<div class="listingblock">
<div class="content">
<pre><code>logicaldrive &lt;device&gt; &lt;slot nr&gt;|&lt;array name&gt;|&lt;logical drive name&gt; raid=&lt;raid level&gt; drives=&lt;drive1,drive2&gt; [spares=&lt;spare1,spare2&gt;]  [sectors=&lt;sectors&gt;] [stripesize=&lt;stripe size&gt;]</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_disk_restore_script_recover_mode">6.7. Disk Restore Script (recover mode)</h3>
<div class="paragraph"><p>The <code>/var/lib/rear/layout/disklayout.conf</code> file is being used as input during <code>rear recover</code> to create on-the-fly a script called <code>/var/lib/rear/layout/diskrestore.sh</code>.
When something goes wrong during the recreation of partitions, volume groups you will be thrown in edit mode and you can make the modification needed. However, it is desirable to have a preview mode before doing the recovery so you can review the <code>diskrestore.sh</code> script before doing any recovery. It is better to find mistakes, obsolete arguments and so on before then later, right?</p></div>
<div class="paragraph"><p>Gratien wrote a script to accomplish this (script is not part of ReaR) and is meant for debugging reasons only. For more details see <a href="http://www.it3.be/2016/06/08/rear-diskrestore/">http://www.it3.be/2016/06/08/rear-diskrestore/</a></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tips_and_tricks_using_relax_and_recover">7. Tips and Tricks using Relax-and-Recover</h2>
<div class="sectionbody">
<div class="paragraph"><p>Recovering a system should not be a struggle against time with poor
tools weighing against you. Relax-and-Recover emphasizes on a relaxing
recovery, and for this it follows three distinct rules:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Do what is generally expected, if possible
</p>
</li>
<li>
<p>
In doubt, ask the operator or allow intervention
</p>
</li>
<li>
<p>
Provide an environment that is as convenient as possible
</p>
</li>
</ol></div>
<div class="paragraph"><p>This results in the following useful tips and tricks:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Relax-and-Recover can add its own GRUB menu entry to your local system&#8217;s
    GRUB, which is convenient to restore a system without the need for an
    additional boot media. This only works if your system can (still)
    boot from the local disk and the disaster didn&#8217;t destroy that disk.
</p>
</li>
<li>
<p>
Relax-and-Recover automatically detects and enables serial console support.
    This is extremely useful if the only way to access the console during
    disaster is a Java-based console riddled with keyboard bugs and slow screen
    refreshes.
</p>
</li>
<li>
<p>
Relax-and-Recover conveniently ships with a set of useful commands in its
    shell history. This makes it possible to quickly look for a command to help
    troubleshoot, or modify an important file during recovery.
</p>
</li>
<li>
<p>
If you have keyboard problems using a HP iLO 2 Remote Console, type the
    following command <code>loadkeys -d</code> (or simply use the up arrow key to get
    this command from your shell history).
</p>
</li>
<li>
<p>
If the original system was configured to log on remotely through the use
    of SSH keys, Relax-and-Recover preserved those keys on the rescue
    environment and you can access the rescue environment from the network
    as you were used to before.
</p>
</li>
<li>
<p>
During recovery at any stage you can re-run Relax-and-Recover, modify
    the layout file for recreating the structure and intervene when restoring
    the backup.
</p>
</li>
</ol></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting_relax_and_recover">8. Troubleshooting Relax-and-Recover</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you encounter a problem, you may find more information in the log file
which is located at <em>/var/log/rear/rear-system.log</em>. During recovery the backup
log file is also available from <em>/var/log/rear/</em>, for your convenience the
history in rescue mode comes with useful commands for debugging, use the up
arrow key in the shell to find those commands.</p></div>
<div class="paragraph"><p>There are a few options in Relax-and-Recover to help you debug the situation:</p></div>
<div class="ulist"><ul>
<li>
<p>
use the <code>-v</code> option to show progress output during execution
</p>
</li>
<li>
<p>
use the <code>-d</code> option to have debug information in your log file
</p>
</li>
<li>
<p>
use the <code>-s</code> option to see what scripts Relax-and-Recover would be using;
   this is useful to understand how Relax-and-Recover is working internally
</p>
</li>
<li>
<p>
use the <code>-S</code> option to step through each individual script when
   troubleshooting
</p>
</li>
<li>
<p>
use the <code>-D</code> option to dump every function call to log file; this is very
   convenient during development or when troubleshooting Relax-and-Recover
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_during_backup">8.1. During backup</h3>
<div class="paragraph"><p>During backup Relax-and-Recover creates a description of your system layout
in one file (<em>disklayout.conf</em>) and stores this as part of its rescue image.
This file describes the configuration of SmartArray RAID, partitions,
software RAID, DRBD, logical volumes, filesystems, and possibly more.</p></div>
<div class="paragraph"><p>Here is a list of known issues during backup:</p></div>
<div class="qlist qanda"><ol>
<li>
<p><em>
One or more HP SmartArray controllers have errors
</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Relax-and-Recover had detected that one of your HP SmartArray controllers is
in ERROR state and as a result it can not trust the information returned from
that controller. This can be dangerous because we cannot guarantee that the
disk layout is valid when recovering the system.</p></div>
<div class="paragraph"><p>We discovered that this problem can be caused by a controller that still
has information in its cache that has not been flushed and the only way to
solve it was to reboot the system and pressing F2 during the controller
initialization when it reports this problem.</p></div>
</div></div>
</li>
<li>
<p><em>
USB sticks disappear and re-appear with difference device name
</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>We have had issues before with a specific batch of JetFlash USB sticks
which, during write operations, reset the USB controller because of a bug
in the Linux kernel. The behavior is that the device disappears (during
write operations!) and reappears with a different device name. The result
is that the filesystem becomes corrupt and the stick cannot be used.</p></div>
<div class="paragraph"><p>To verify if the USB stick has any issues like this, we recommend using
the <code>f3</code> tool on Linux or the <code>h2testw</code> tool on Windows. If this tool
succeeds in a write and verify test, the USB stick is reliable.</p></div>
</div></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_during_recovery">8.2. During recovery</h3>
<div class="paragraph"><p>During restore Relax-and-Recover uses the saved system layout as the basis for
recreating a workable layout on your new system. If your new hardware is very
different, it&#8217;s advised to copy the layout file
<em>/var/lib/rear/layout/disklayout.conf</em> to <em>/etc/rear</em> and modify it according
to what is required.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>cp /var/lib/rear/layout/disklayout.conf /etc/rear/
vi /etc/rear/disklayout.conf</code></pre>
</div></div>
<div class="paragraph"><p>Then restart the recovery process: <code>rear recover</code></p></div>
<div class="paragraph"><p>During the recovery process, Relax-and-Recover translates this layout file
into a shell procedure (<em>/var/lib/rear/layout/diskrestore.sh</em>) that contains
all the needed instructions for recreating your desired layout.</p></div>
<div class="paragraph"><p>If Relax-and-Recover comes across irreconcilable differences, it provides you
with a small menu of options you have. In any case you can Abort the menu, and
retry after cleaning up everything Relax-and-Recover may already have done, incl.
<code>mdadm --stop --scan</code> or <code>vgchange -a n</code>.</p></div>
<div class="paragraph"><p>In any case, you will have to look into the issue, see what goes wrong and
either fix the layout file (<em>disklayout.conf</em>) and restart the recovery
process (<code>rear recover</code>) or instead fix the shell procedure (<em>diskrestore.sh</em>)
and choose <code>Retry</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Customizations to the shell procedure (<em>diskrestore.sh</em>) get
         lost when restarting <code>rear recover</code>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Here is a list of known issues during recovery:</p></div>
<div class="qlist qanda"><ol>
<li>
<p><em>
Failed to clear HP SmartArray controller 1
</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>This error may be caused by trying to clear an HP SmartArray controller
that does not have a configuration or does not exist. Since we have no
means to know whether this is a fatal condition or not we simply try to
recreate the logical drive(s) and see what happens.</p></div>
<div class="paragraph"><p>This message is harmless, but may help troubleshoot the subsequent error
message.</p></div>
</div></div>
</li>
<li>
<p><em>
An error has been detected during restore
</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>The (generated) layout restore script <em>/var/lib/rear/layout/diskrestore.sh</em>
was not able to perform all necessary steps without error. The system will
provide you with a menu allowing you to fix the <em>diskrestore.sh</em> script
manually and continue from where it left off.</p></div>
<div class="literalblock">
<div class="content">
<pre><code>Cannot create array. Cannot add physical drive 2I:1:5
Could not configure the HP SmartArray controllers</code></pre>
</div></div>
<div class="paragraph"><p>When the number of physical or logical disks are different, or when other
important system characteristics that matter to recovery are incompatible,
this will be indicated by a multitude of possible error-messages.
Relax-and-Recover makes it possible to recover also in these cases by hand.</p></div>
<div class="paragraph"><p>You can find more information about your HP SmartArray setup by running one of
the following commands:</p></div>
<div class="literalblock">
<div class="content">
<pre><code># hpacucli ctrl all show detail
# hpacucli ctrl all show config
# hpacucli ctrl all show config detail</code></pre>
</div></div>
</div></div>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">You can find these commands as part of the history of the
Relax-and-Recover shell.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_concepts_2">9. Design concepts</h2>
<div class="sectionbody">
<div class="paragraph"><p>Schlomo Schapiro, Gratien D&#8217;haese, Dag Wieers</p></div>
<div class="sect2">
<h3 id="_the_workflow_system">9.1. The Workflow System</h3>
<div class="paragraph"><p>Relax-and-Recover is built as a modular framework. A call of <code>rear &lt;command&gt;</code>
will invoke the following general workflow:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Configuration:</strong> Collect system information to assemble a correct
     configuration (default, arch, OS, OS_ARCH, OS_VER, site, local).
     See the output of <code>rear dump</code> for an example.
    <br />
     Read config files for the combination of system attributes. Always
     read <em>default.conf</em> first and <em>site.conf</em>, <em>local.conf</em> last.
</p>
</li>
<li>
<p>
Create work area in <em>/tmp/rear.$$/</em> and start logging to
     <em>/var/log/rear/rear-hostname.log</em>
</p>
</li>
<li>
<p>
Run the workflow script for the specified command:
     <em>/usr/share/rear/lib/&lt;command&gt;-workflow.sh</em>
</p>
</li>
<li>
<p>
Cleanup work area
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_workflow_make_rescue_media">9.2. Workflow - Make Rescue Media</h3>
<div class="paragraph"><p>The application will have the following general workflow which is represented
by appropriately named scripts in various subdirectories:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Prep:</strong> Prepare the build area by copying a skeleton filesystem layout.
     This can also come from various sources (FS layout for arch, OS, OS_VER,
     Backup-SW, Output, &#8230;)
</p>
</li>
<li>
<p>
<strong>Analyse disklayout</strong>: Analyse the system disklayout to create the <em>/var/lib/rear/layout/</em> data
</p>
</li>
<li>
<p>
<strong>Analyse (Rescue):</strong> Analyse the system to create the rescue system
     (network, binary dependencies, &#8230;)
</p>
</li>
<li>
<p>
<strong>Build:</strong> Build the rescue image by copying together everything required
</p>
</li>
<li>
<p>
<strong>Pack:</strong> Package the kernel and initrd image together
</p>
</li>
<li>
<p>
<strong>Backup:</strong> (Optionally) run the backup software to create a current backup
</p>
</li>
<li>
<p>
<strong>Output:</strong> Copy / Install the rescue system (kernel+initrd+(optionally)
     backups) into the target environment (e.g. PXE boot, write on tape,
     write on CD/DVD)
</p>
</li>
<li>
<p>
<strong>Cleanup:</strong> Cleanup the build area from temporary files
</p>
</li>
</ol></div>
<div class="paragraph"><p>The configuration must define the <code>BACKUP</code> and <code>OUTPUT</code> methods. Valid choices are:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">NAME</p></td>
<td align="left" valign="top"><p class="table">TYPE</p></td>
<td align="left" valign="top"><p class="table">Description</p></td>
<td align="left" valign="top"><p class="table">Implement in Phase</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">NETFS</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Copy files to NFS/CIFS share</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">TAPE</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Copy files to tape(s)</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DUPLICITY</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Copy files to the Cloud</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">NSR</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use Legato Networker</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">TSM</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use Tivoli Storage Manager</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DP</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use HP DataProtector</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">NBU</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use Symantec NetBackup</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BACULA</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use Bacula</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BAREOS</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use fork of Bacula</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RSYNC</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use rsync to remote location</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RBME</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use Rsync Backup Made Easy</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FDRUPSTREAM</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use FDR/Upstream</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BORG</p></td>
<td align="left" valign="top"><p class="table">BACKUP</p></td>
<td align="left" valign="top"><p class="table">Use Borg</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ISO</p></td>
<td align="left" valign="top"><p class="table">OUTPUT</p></td>
<td align="left" valign="top"><p class="table">Write result to ISO9660 image</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">OBDR</p></td>
<td align="left" valign="top"><p class="table">OUTPUT</p></td>
<td align="left" valign="top"><p class="table">Create OBDR Tape</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PXE</p></td>
<td align="left" valign="top"><p class="table">OUTPUT</p></td>
<td align="left" valign="top"><p class="table">Create PXE bootable files on TFTP server</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">USB</p></td>
<td align="left" valign="top"><p class="table">OUTPUT</p></td>
<td align="left" valign="top"><p class="table">Create bootable USB device</p></td>
<td align="left" valign="top"><p class="table">done</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_workflow_recovery">9.3. Workflow - Recovery</h3>
<div class="paragraph"><p>The result of the analysis is written into configuration files under
<em>/etc/rear/recovery/</em>. This directory is copied together with the other
Relax-and-Recover directories onto the rescue system where the same
framework runs a different workflow - the recovery workflow.</p></div>
<div class="paragraph"><p>The recovery workflow is triggered by the fact that the root filesystem is
mounted in a ram disk or tmpfs. Alternatively a "demo" recovery workflow
can be started manually. This will simply recover all data into a
subdirectory and not touch the hard disks (Phase 2).</p></div>
<div class="paragraph"><p>The recovery workflow consists of these parts (identically named modules
are indeed the same):</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Config:</strong> By utilizing the same configuration module, the same
     configuration variable are available for the recovery, too.
     This makes writing pairs of backup/restore modules much easier.
</p>
</li>
<li>
<p>
<strong>Verify:</strong> Verify the integrity and sanity of the recovery data and
     check the hardware found to determine, whether a recovery will be
     likely to succeed. If not, then we abort the workflow so as not to
     touch the hard disks if we don&#8217;t believe that we would manage to
     successfully recover the system on this hardware.
</p>
</li>
<li>
<p>
<strong>Recreate:</strong> Recreate the FS layout (partitioning, LVM, raid,
     filesystems, &#8230;) and mount it under /mnt/local
</p>
</li>
<li>
<p>
<strong>Restore:</strong> Restore files and directories from the backup to <em>/mnt/local/</em>.
     This module is the analog to the Backup module
</p>
</li>
<li>
<p>
<strong>Finalize:</strong> Install boot loader, finalize system, dump recovery log
     onto <em>/var/log/rear/</em> in the recovered system.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_fs_layout">9.4. FS layout</h3>
<div class="paragraph"><p>Relax-and-Recover tries to be as much LSB compliant as possible. Therefore ReaR will be
installed into the usual locations:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
/etc/rear/
</dt>
<dd>
<p>
    Configurations
</p>
</dd>
<dt class="hdlist1">
/usr/sbin/rear
</dt>
<dd>
<p>
    Main program
</p>
</dd>
<dt class="hdlist1">
/usr/share/rear/
</dt>
<dd>
<p>
    Internal scripts
</p>
</dd>
<dt class="hdlist1">
/tmp/rear.$$/
</dt>
<dd>
<p>
    Build area
</p>
</dd>
</dl></div>
<div class="sect3">
<h4 id="_layout_of_etc_rear">9.4.1. Layout of /etc/rear</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
default.conf
</dt>
<dd>
<p>
    Default configuration - will define EVERY variable with a sane default
    setting. Serves also as a reference for the available variables <em>site.conf</em>
    site wide configuration (optional)
</p>
</dd>
<dt class="hdlist1">
local.conf
</dt>
<dd>
<p>
    local machine configuration (optional)
</p>
</dd>
<dt class="hdlist1">
$(uname -s)-$(uname -i).conf
</dt>
<dd>
<p>
    architecture specific configuration (optional)
</p>
</dd>
<dt class="hdlist1">
$(uname -o).conf
</dt>
<dd>
<p>
    OS system (e.g. GNU/Linux.conf) (optional)
</p>
</dd>
<dt class="hdlist1">
$OS/$OS_VER.conf
</dt>
<dd>
<p>
    OS and OS Version specific configuration (optional)
</p>
</dd>
<dt class="hdlist1">
templates/
</dt>
<dd>
<p>
    Directory to keep user-changeable templates for various files used
    or generated
</p>
</dd>
<dt class="hdlist1">
templates/PXE_per_node_config
</dt>
<dd>
<p>
    template for pxelinux.cfg per-node configurations
</p>
</dd>
<dt class="hdlist1">
templates/CDROM_isolinux.cfg
</dt>
<dd>
<p>
    isolinux.cfg template
</p>
</dd>
<dt class="hdlist1">
templates/&#8230;
</dt>
<dd>
<p>
    other templates as the need arises
</p>
</dd>
<dt class="hdlist1">
recovery/&#8230;
</dt>
<dd>
<p>
    Recovery information
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_layout_of_usr_share_rear">9.4.2. Layout of /usr/share/rear</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
skel/default/
</dt>
<dd>
<p>
    default rescue FS skeleton
</p>
</dd>
<dt class="hdlist1">
skel/$(uname -i)/
</dt>
<dd>
<p>
    arch specific rescue FS skeleton (optional)
</p>
</dd>
<dt class="hdlist1">
skel/$OS_$OS_VER/
</dt>
<dd>
<p>
    OS-specific rescue FS skeleton (optional)
</p>
</dd>
<dt class="hdlist1">
skel/$BACKUP/
</dt>
<dd>
<p>
    Backup-SW specific rescue FS skeleton (optional)
</p>
</dd>
<dt class="hdlist1">
skel/$OUTPUT/
</dt>
<dd>
<p>
    Output-Method specific rescue FS skeleton (optional)
</p>
</dd>
<dt class="hdlist1">
lib/*.sh
</dt>
<dd>
<p>
    function definitions, split into files by their topic
</p>
</dd>
<dt class="hdlist1">
prep/default/*.sh
</dt>
<dt class="hdlist1">
prep/$(uname -i)/*.sh
</dt>
<dt class="hdlist1">
prep/$OS_$OS_VER/*.sh
</dt>
<dt class="hdlist1">
prep/$BACKUP/*.sh
</dt>
<dt class="hdlist1">
prep/$OUTPUT/*.sh
</dt>
<dd>
<p>
    Prep scripts. The scripts get merged from the applicable directories
    and executed in their alphabetical order. Naming conventions are:
   <br />
    _name.sh
   <br />
    where 00 &lt;  &lt; 99
</p>
</dd>
<dt class="hdlist1">
layout/compare/default/
</dt>
<dt class="hdlist1">
layout/compare/$OS_$OS_VER/
</dt>
<dd>
<p>
    Scripts to compare the saved layout (under /var/lib/rear/layout/) with the actual situation. This is used by workflow <strong>rear checklayout</strong> and may trigger a new run of <strong>rear mkrescue</strong> or <strong>rear mkbackup</strong>
</p>
</dd>
<dt class="hdlist1">
layout/precompare/default/
</dt>
<dt class="hdlist1">
layout/precompare/$OS_$OS_VER/
</dt>
<dt class="hdlist1">
layout/prepare/default/
</dt>
<dt class="hdlist1">
layout/prepare/$OS_$OS_VER/
</dt>
<dt class="hdlist1">
layout/recreate/default/
</dt>
<dt class="hdlist1">
layout/recreate/$OS_$OS_VER/
</dt>
<dt class="hdlist1">
layout/save/default/
</dt>
<dt class="hdlist1">
layout/save/$OS_$OS_VER/
</dt>
<dd>
<p>
    Scripts to capture the disk layout and write it into /var/lib/rear/layout/ directory
</p>
</dd>
<dt class="hdlist1">
rescue/&#8230;
</dt>
<dd>
<p>
    Analyse-Rescue scripts: &#8230;
</p>
</dd>
<dt class="hdlist1">
build/&#8230;
</dt>
<dd>
<p>
    Build scripts: &#8230;
</p>
</dd>
<dt class="hdlist1">
pack/&#8230;
</dt>
<dd>
<p>
    Pack scripts: &#8230;
</p>
</dd>
<dt class="hdlist1">
backup/$BACKUP/*.sh
</dt>
<dd>
<p>
    Backup scripts: &#8230;
</p>
</dd>
<dt class="hdlist1">
output/$OUTPUT/*.sh
</dt>
<dd>
<p>
    Output scripts: &#8230;
</p>
</dd>
<dt class="hdlist1">
verify/&#8230;
</dt>
<dd>
<p>
    Verify the recovery data against the hardware found, whether we can
    successfully recover the system
</p>
</dd>
<dt class="hdlist1">
recreate/&#8230;
</dt>
<dd>
<p>
    Recreate file systems and their dependancies
</p>
</dd>
<dt class="hdlist1">
restore/$BACKUP/&#8230;
</dt>
<dd>
<p>
    Restore data from backup media
</p>
</dd>
<dt class="hdlist1">
finalize/&#8230;
</dt>
<dd>
<p>
    Finalization scripts
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect2">
<h3 id="_inter_module_communication">9.5. Inter-module communication</h3>
<div class="paragraph"><p>The various stages and modules communicate via standardized environment variables:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">NAME</p></td>
<td align="left" valign="top"><p class="table">TYPE</p></td>
<td align="left" valign="top"><p class="table">Descriptions</p></td>
<td align="left" valign="top"><p class="table">Example</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CONFIG_DIR</p></td>
<td align="left" valign="top"><p class="table">STRING (RO)</p></td>
<td align="left" valign="top"><p class="table">Configuration dir</p></td>
<td align="left" valign="top"><p class="table"><em>/etc/rear/</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SHARE_DIR</p></td>
<td align="left" valign="top"><p class="table">STRING (RO)</p></td>
<td align="left" valign="top"><p class="table">Shared data dir</p></td>
<td align="left" valign="top"><p class="table"><em>/usr/share/rear/</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BUILD_DIR</p></td>
<td align="left" valign="top"><p class="table">STRING (RO)</p></td>
<td align="left" valign="top"><p class="table">Build directory</p></td>
<td align="left" valign="top"><p class="table"><em>/tmp/rear.$$/</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ROOTFS_DIR</p></td>
<td align="left" valign="top"><p class="table">STRING (RO)</p></td>
<td align="left" valign="top"><p class="table">Root FS directory for rescue system</p></td>
<td align="left" valign="top"><p class="table"><em>/tmp/rear.$$/initrd/</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">TARGET_FS_ROOT</p></td>
<td align="left" valign="top"><p class="table">STRING (RO)</p></td>
<td align="left" valign="top"><p class="table">Directory for restore</p></td>
<td align="left" valign="top"><p class="table"><em>/mnt/local</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PROGS</p></td>
<td align="left" valign="top"><p class="table">LIST</p></td>
<td align="left" valign="top"><p class="table">Program files to copy</p></td>
<td align="left" valign="top"><p class="table"><code>bash ip route grep ls</code> &#8230;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">MODULES</p></td>
<td align="left" valign="top"><p class="table">LIST</p></td>
<td align="left" valign="top"><p class="table">Modules to copy</p></td>
<td align="left" valign="top"><p class="table"><code>af_unix e1000 ide-cd</code> &#8230;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">COPY_AS_IS</p></td>
<td align="left" valign="top"><p class="table">LIST</p></td>
<td align="left" valign="top"><p class="table">Files (with path) to copy as-is</p></td>
<td align="left" valign="top"><p class="table"><em>/etc/localtime</em> &#8230;</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>RO means that the framework manages this variable and modules and methods shouldn&#8217;t change it.</p></div>
</div>
<div class="sect2">
<h3 id="_major_changes_compared_with_mkcdrec">9.6. Major changes compared with mkCDrec</h3>
<div class="ulist"><ul>
<li>
<p>
No Makefiles
</p>
</li>
<li>
<p>
Major script called xxx that arranges all
</p>
</li>
<li>
<p>
Simplify the testing and configuration
</p>
</li>
<li>
<p>
Being less verbose
</p>
</li>
<li>
<p>
Better control over echo to screen, log file or debugging
</p>
</li>
<li>
<p>
Less color
</p>
</li>
<li>
<p>
Easier integration with third party software (GPL or commercial)
</p>
</li>
<li>
<p>
Modular and plug-ins should be easy for end-users
</p>
</li>
<li>
<p>
Better documentation for developers
</p>
</li>
<li>
<p>
Cut the overhead - less is better
</p>
</li>
<li>
<p>
Less choices (&#8658; less errors)
</p>
</li>
<li>
<p>
<strong>mkCDrec project is not active more</strong>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_external_backup_programs_into_rear">10. Integrating external backup programs into ReaR</h2>
<div class="sectionbody">
<div class="paragraph"><p>Relax-and-Recover can be used only to restore the disk layout of your system and boot loader. However, that means you are responsible for taking backups. And, more important, to restore these before you reboot recovered system.</p></div>
<div class="paragraph"><p>However, we have successfully already integrated external backup programs within ReaR, such as Netbackup, EMC NetWorker, Tivoli Storage Manager, Data Protetctor to name a few commercial backup programs. Furthermore, open source external backup programs which are also working with ReaR are Bacula, Bareos, Duplicity and Borg to name the most known ones.</p></div>
<div class="paragraph"><p>Ah, my backup program which is the best of course, is not yet integrated within ReaR. How shall we proceed to make your backup program working with ReaR? This is a step by step approach.</p></div>
<div class="paragraph"><p>The work-flow <code>mkrescue</code> is the only needed as <code>mkbackup</code> will not create any backup as it is done outside ReaR anyhow. Very important to know.</p></div>
<div class="sect2">
<h3 id="_think_before_coding">10.1. Think before coding</h3>
<div class="paragraph"><p>Well, what does this mean? Is my backup program capable of making full backups of my root disks, including ACLs? And, as usual, did we test a restore of a complete system already? Can we do a restore via the command line, or do we need a graphical user interface to make this happen?
If the CLI approach is working then this would be the preferred manor for ReaR. If on the other hand only GUI approach is possible, then can you initiate a push from the media server instead of the pull method (which we could program within ReaR)?</p></div>
<div class="paragraph"><p>So, most imprtant things to remember here are:</p></div>
<div class="ulist"><ul>
<li>
<p>
CLI - preferred method (and far the easiest one to integrate within ReaR) - pull method
</p>
</li>
<li>
<p>
GUI - as ReaR has no X Windows available (only command line) we cannot use the GUI within ReaR, however, GUI is still possible from another system (media server or backup server) and push out the restore to the recovered system. This method is similar to the REQUESTRESTORE BACKUP method.
</p>
</li>
</ul></div>
<div class="paragraph"><p>What does ReaR need to have on board before we can initiate a restore from your backup program?</p></div>
<div class="ulist"><ul>
<li>
<p>
the executables (and libraries) from your backup program (only client related)
</p>
</li>
<li>
<p>
configuration files required by above executables?
</p>
</li>
<li>
<p>
most likely you need the manuals a bit to gather some background information of your backup program around its minimum requirements
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_steal_code_from_previous_backup_integrations">10.2. Steal code from previous backup integrations</h3>
<div class="paragraph"><p>Do not make your life too difficult by re-invented the wheel. Have a look at existing integrations. How?</p></div>
<div class="paragraph"><p>Start with the default configuration file of ReaR:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ cd /usr/share/rear/conf
$ grep -r NBU *
default.conf:# BACKUP=NBU stuff (Symantec/Veritas NetBackup)
default.conf:COPY_AS_IS_NBU=( /usr/openv/bin/vnetd /usr/openv/bin/vopied /usr/openv/lib /usr/openv/netbackup /usr/openv/var/auth/[mn]*.txt )
default.conf:COPY_AS_IS_EXCLUDE_NBU=( "/usr/openv/netbackup/logs/*" "/usr/openv/netbackup/bin/bpjava*" "/usr/openv/netbackup/bin/xbp" )
default.conf:PROGS_NBU=( )</code></pre>
</div></div>
<div class="paragraph"><p>What does this learn you?</p></div>
<div class="ulist"><ul>
<li>
<p>
you need to define a backup method name, e.g. <code>BACKUP=NBU</code> (must be unique within ReaR!)
</p>
</li>
<li>
<p>
define some new variables to automatically copy executables into the ReaR rescue image, and one to exclude stuff which is not required by the recovery (this means you have to play with it and fine-tune it)
</p>
</li>
<li>
<p>
finally, define a place holder array for your backup programs (is empty to start with).
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now, you have defined a new BACKUP scheme name, right? As an example take the name BURP (<a href="http://burp.grke.org/">http://burp.grke.org/</a>).</p></div>
<div class="paragraph"><p>Define in /usr/share/rear/conf/default:</p></div>
<div class="literalblock">
<div class="content">
<pre><code># BACKUP=BURP section (Burp program stuff)
COPY_AS_IS_BURP=( )
COPY_AS_IS_EXCLUDE_BURP=( )
PROGS_BURP=( )</code></pre>
</div></div>
<div class="paragraph"><p>Of course, the tricky part is what should above arrays contain? That you should already know as that was part of the first task (<strong>Think before coding</strong>).</p></div>
<div class="paragraph"><p>This is only the start of learning what others have done before:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ cd /usr/share/rear
$ find . -name NBU
./finalize/NBU
./prep/NBU
./rescue/NBU
./restore/NBU
./skel/NBU
./verify/NBU</code></pre>
</div></div>
<div class="paragraph"><p>What does this mean? Well, these are directories created for Netbackup and beneath these directories are scripts that will be included during the <code>mkrescue</code> and <code>recover</code> work-flows.</p></div>
<div class="paragraph"><p>Again, think burp, and you probably also need these directories to be created:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ mkdir --mode=755 /usr/share/rear/{finalize,prep,rescue,restore,verify}/BURP</code></pre>
</div></div>
<div class="paragraph"><p>Another easy trick is to look at the existing scripts of NBU (as a starter):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ sudo rear -s mkrescue | grep NBU
Source prep/NBU/default/400_prep_nbu.sh
Source prep/NBU/default/450_check_nbu_client_configured.sh
Source rescue/NBU/default/450_prepare_netbackup.sh
Source rescue/NBU/default/450_prepare_xinetd.sh</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>$ sudo rear -s recover | grep NBU
Source verify/NBU/default/380_request_client_destination.sh
Source verify/NBU/default/390_request_point_in_time_restore_parameters.sh
Source verify/NBU/default/400_verify_nbu.sh
Source restore/NBU/default/300_create_nbu_restore_fs_list.sh
Source restore/NBU/default/400_restore_with_nbu.sh
Source finalize/NBU/default/990_copy_bplogrestorelog.sh</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_multiple_backups_for_relax_and_recover">11. Using Multiple Backups for Relax-and-Recover</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basics">11.1. Basics</h3>
<div class="paragraph"><p>Currently multiple backups are only supported for:</p></div>
<div class="ulist"><ul>
<li>
<p>
the internal BACKUP=NETFS method with BACKUP_TYPE=""
</p>
</li>
<li>
<p>
the internal BACKUP=BLOCKCLONE method
</p>
</li>
<li>
<p>
the external BACKUP=BORG method
</p>
</li>
</ul></div>
<div class="paragraph"><p>In general multiple backups are not supported for
BACKUP_TYPE=incremental or BACKUP_TYPE=differential
because those require special backup archive file names.</p></div>
<div class="sect3">
<h4 id="_the_basic_idea_behind">11.1.1. The basic idea behind</h4>
<div class="paragraph"><p>A "rear mkbackup" run can be split into
a "rear mkrescue" run plus a "rear mkbackuponly" run
and the result is still the same.</p></div>
<div class="paragraph"><p>Accordingly "rear mkbackup" can be split into
a single "rear mkrescue" plus multiple "rear mkbackuponly"
where each particular "rear mkbackuponly" backups only a
particular part of the files of the system, for example:</p></div>
<div class="ulist"><ul>
<li>
<p>
a backup of the files of the basic system
</p>
</li>
<li>
<p>
a backup of the files in the /home directories
</p>
</li>
<li>
<p>
a backup of the files in the /opt directory
</p>
</li>
</ul></div>
<div class="paragraph"><p>Multiple "rear mkbackuponly" require that each particular
"rear mkbackuponly" uses a specific ReaR configuration file
that specifies how that particular "rear mkbackuponly" must be done.</p></div>
<div class="paragraph"><p>Therefore the <em>-C</em> command line parameter is needed where
an additional ReaR configuration file can be specified.</p></div>
</div>
<div class="sect3">
<h4 id="_the_basic_way_how_to_create_multiple_backups">11.1.2. The basic way how to create multiple backups</h4>
<div class="paragraph"><p>Have common settings in /etc/rear/local.conf</p></div>
<div class="paragraph"><p>For each particular backup specify its parameters in
a separated additional configuration files like</p></div>
<div class="listingblock">
<div class="content">
<pre><code>/etc/rear/basic_system.conf
/etc/rear/home_backup.conf
/etc/rear/opt_backup.conf</code></pre>
</div></div>
<div class="paragraph"><p>First create the ReaR recovery/rescue system ISO image
together with a backup of the files of the basic system:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system mkbackup</code></pre>
</div></div>
<div class="paragraph"><p>Then backup the files in the /home directories:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C home_backup mkbackuponly</code></pre>
</div></div>
<div class="paragraph"><p>Afterwards backup the files in the /opt directory:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C opt_backup mkbackuponly</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_the_basic_way_how_to_recover_with_multiple_backups">11.1.3. The basic way how to recover with multiple backups</h4>
<div class="paragraph"><p>The basic idea how to recover with multiple backups is
to split the "rear recover" into an initial recovery
of the basic system followed by several backup restore
operations as follows:</p></div>
<div class="paragraph"><p>Boot the ReaR recovery/rescue system.</p></div>
<div class="paragraph"><p>In the ReaR recovery/rescue system do the following:</p></div>
<div class="paragraph"><p>First recover the basic system:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system recover</code></pre>
</div></div>
<div class="paragraph"><p>Then restore the files in the /home directories:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C home_backup restoreonly</code></pre>
</div></div>
<div class="paragraph"><p>Afterwards restore the files in the /opt directory:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C opt_backup restoreonly</code></pre>
</div></div>
<div class="paragraph"><p>Finally reboot the recreated system.</p></div>
<div class="paragraph"><p>For more internal details and some background information see
<a href="https://github.com/rear/rear/issues/1088">https://github.com/rear/rear/issues/1088</a></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_relax_and_recover_setup_for_multiple_backups">11.2. Relax-and-Recover Setup for Multiple Backups</h3>
<div class="paragraph"><p>Assume for example multiple backups should be done
using the NETFS backup method with <em>tar</em> as backup program
to get separated backups for:</p></div>
<div class="ulist"><ul>
<li>
<p>
the files of the basic system
</p>
</li>
<li>
<p>
the files in the /home directories
</p>
</li>
<li>
<p>
the files in the /opt directory
</p>
</li>
</ul></div>
<div class="paragraph"><p>Those four configuration files could be used:</p></div>
<div class="listingblock">
<div class="title">/etc/rear/local.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">BACKUP_OPTIONS</span><span style="color: #990000">=</span><span style="color: #FF0000">"nfsvers=3,nolock"</span>
<span style="color: #009900">BACKUP_URL</span><span style="color: #990000">=</span>nfs<span style="color: #990000">:</span>//your<span style="color: #990000">.</span>NFS<span style="color: #990000">.</span>server<span style="color: #990000">.</span>IP/path/to/your/rear/backup</tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/basic_system.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"</span>
<span style="color: #009900">BACKUP_PROG_EXCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">"${BACKUP_PROG_EXCLUDE[@]}"</span> <span style="color: #FF0000">'/home/*'</span> <span style="color: #FF0000">'/opt/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BACKUP_PROG_ARCHIVE</span><span style="color: #990000">=</span><span style="color: #FF0000">"backup-${this_file_name%.*}"</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/home_backup.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"</span>
<span style="color: #009900">BACKUP_ONLY_INCLUDE</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="color: #009900">BACKUP_PROG_INCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">'/home/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BACKUP_PROG_ARCHIVE</span><span style="color: #990000">=</span><span style="color: #FF0000">"backup-${this_file_name%.*}"</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/opt_backup.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"</span>
<span style="color: #009900">BACKUP_ONLY_INCLUDE</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="color: #009900">BACKUP_PROG_INCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">'/opt/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BACKUP_PROG_ARCHIVE</span><span style="color: #990000">=</span><span style="color: #FF0000">"backup-${this_file_name%.*}"</span></tt></pre></div></div>
<div class="paragraph"><p>The BACKUP_ONLY_INCLUDE setting is described in conf/default.conf.</p></div>
<div class="paragraph"><p>With those config files creating the ReaR recovery/rescue system ISO image
and subsequently backup the files of the system could be done like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear mkrescue
rear -C basic_system mkbackuponly
rear -C home_backup mkbackuponly
rear -C opt_backup mkbackuponly</code></pre>
</div></div>
<div class="paragraph"><p>Recovery of that system could be done by calling in the
ReaR recovery/rescue system:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system recover
rear -C home_backup restoreonly
rear -C opt_backup restoreonly</code></pre>
</div></div>
<div class="paragraph"><p>Note that system recovery with multiple backups requires that
first and foremost the basic system is recovered where all files
must be restored that are needed to install the bootloader and
to boot the basic system into a normal usable state.</p></div>
<div class="paragraph"><p>Nowadays systemd usually needs files in the /usr directory
so that in practice in particular all files in the /usr directory
must be restored during the initial basic system recovery
plus whatever else is needed to boot and run the basic system.</p></div>
<div class="paragraph"><p>Multiple backups cannot be used to spilt the files of the basic system
into several backups. The files of the basic system must be in one
single backup and that backup must be restored during the initial
recovery of the basic system.</p></div>
</div>
<div class="sect2">
<h3 id="_relax_and_recover_setup_for_different_backup_methods">11.3. Relax-and-Recover Setup for Different Backup Methods</h3>
<div class="paragraph"><p>Because multiple backups are used via separated additional
configuration files, different backup methods can be used.</p></div>
<div class="paragraph"><p>Assume for example multiple backups should be used to get
separated backups for the files of the basic system
using the NETFS backup method with <em>tar</em> as backup program
and to backup the files in the /home directory
using the BORG backup method.</p></div>
<div class="paragraph"><p>The configuration files could be like the following:</p></div>
<div class="listingblock">
<div class="title">/etc/rear/local.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">REQUIRED_PROGS</span><span style="color: #990000">=(</span> <span style="color: #FF0000">"${REQUIRED_PROGS[@]}"</span> borg locale <span style="color: #990000">)</span>
<span style="color: #009900">COPY_AS_IS</span><span style="color: #990000">=(</span> <span style="color: #FF0000">"${COPY_AS_IS[@]}"</span> <span style="color: #FF0000">"/borg/keys"</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/basic_system.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"</span>
<span style="color: #009900">BACKUP_PROG_EXCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">"${BACKUP_PROG_EXCLUDE[@]}"</span> <span style="color: #FF0000">'/home/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BACKUP_PROG_ARCHIVE</span><span style="color: #990000">=</span><span style="color: #FF0000">"backup-${this_file_name%.*}"</span>
<span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">BACKUP_OPTIONS</span><span style="color: #990000">=</span><span style="color: #FF0000">"nfsvers=3,nolock"</span>
<span style="color: #009900">BACKUP_URL</span><span style="color: #990000">=</span>nfs<span style="color: #990000">:</span>//your<span style="color: #990000">.</span>NFS<span style="color: #990000">.</span>server<span style="color: #990000">.</span>IP/path/to/your/rear/backup</tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/home_backup.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"</span>
<span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>BORG
<span style="color: #009900">BACKUP_ONLY_INCLUDE</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="color: #009900">BACKUP_PROG_INCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">'/home/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BORGBACKUP_ARCHIVE_PREFIX</span><span style="color: #990000">=</span><span style="color: #FF0000">"rear"</span>
<span style="color: #009900">BORGBACKUP_HOST</span><span style="color: #990000">=</span><span style="color: #FF0000">"borg.server.name"</span>
<span style="color: #009900">BORGBACKUP_USERNAME</span><span style="color: #990000">=</span><span style="color: #FF0000">"borg_server_username"</span>
<span style="color: #009900">BORGBACKUP_REPO</span><span style="color: #990000">=</span><span style="color: #FF0000">"/path/to/borg/repository/on/borg/server"</span>
<span style="color: #009900">BORGBACKUP_PRUNE_HOURLY</span><span style="color: #990000">=</span><span style="color: #993399">5</span>
<span style="color: #009900">BORGBACKUP_PRUNE_WEEKLY</span><span style="color: #990000">=</span><span style="color: #993399">2</span>
<span style="color: #009900">BORGBACKUP_COMPRESSION</span><span style="color: #990000">=</span><span style="color: #FF0000">"zlib,9"</span>
<span style="color: #009900">BORGBACKUP_ENC_TYPE</span><span style="color: #990000">=</span><span style="color: #FF0000">"keyfile"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_KEYS_DIR</span><span style="color: #990000">=</span><span style="color: #FF0000">"/borg/keys"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_CACHE_DIR</span><span style="color: #990000">=</span><span style="color: #FF0000">"/borg/cache"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_PASSPHRASE</span><span style="color: #990000">=</span><span style="color: #FF0000">"a1b2c3_d4e5f6"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_RELOCATED_REPO_ACCESS_IS_OK</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">BORG_REMOTE_PATH</span><span style="color: #990000">=</span><span style="color: #FF0000">"/usr/local/bin/borg"</span></tt></pre></div></div>
<div class="paragraph"><p>Using different backup methods requires to get all the binaries
and all other needed files of all used backup methods into the
ReaR recovery/rescue system during "rear mkbackup/mkrescue".</p></div>
<div class="paragraph"><p>Those binaries and other needed files must be manually specified
via REQUIRED_PROGS and COPY_AS_IS in /etc/rear/local.conf
(regarding REQUIRED_PROGS and COPY_AS_IS see conf/default.conf).</p></div>
<div class="paragraph"><p>With those config files creating the ReaR recovery/rescue system ISO image
together with a <em>tar</em> backup of the files of the basic system and
a separated Borg backup of the files in /home could be done like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C home_backup mkbackuponly
rear -C basic_system mkbackup</code></pre>
</div></div>
<div class="paragraph"><p>In contrast to the other examples above the Borg backup is run first
because Borg creates encryption keys during repository initialization.
This ensures the right /borg/keys is created before it will be copied into
the ReaR recovery/rescue system by the subsequent "rear mkbackup/mkrescue".
Alternatively the ReaR recovery/rescue system could be created again
after the Borg backup is done like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system mkbackup
rear -C home_backup mkbackuponly
rear -C basic_system mkrescue</code></pre>
</div></div>
<div class="paragraph"><p>Recovery of that system could be done by calling in the
ReaR recovery/rescue system:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system recover
rear -C home_backup restoreonly</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_running_multiple_backups_and_restores_in_parallel">11.4. Running Multiple Backups and Restores in Parallel</h3>
<div class="paragraph"><p>When the files in multiple backups are separated from each other
it should work to run multiple backups or multiple restores in parallel.</p></div>
<div class="paragraph"><p>Whether or not that actually works in your particular case
depends on how you made the backups in your particular case.</p></div>
<div class="paragraph"><p>For sufficiently well separated backups it should work
to run multiple different</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C backup_config mkbackuponly</code></pre>
</div></div>
<div class="paragraph"><p>or multiple different</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C backup_config restoreonly</code></pre>
</div></div>
<div class="paragraph"><p>in parallel.</p></div>
<div class="paragraph"><p>Running in parallel is only supported for mkbackuponly and restoreonly.</p></div>
<div class="paragraph"><p>For example like</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C backup1 mkbackuponly &amp; rear -C backup2 mkbackuponly &amp; wait</code></pre>
</div></div>
<div class="paragraph"><p>or</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C backup1 restoreonly &amp; rear -C backup2 restoreonly &amp; wait</code></pre>
</div></div>
<div class="paragraph"><p>ReaR&#8217;s default logging is not prepared for multiple simultaneous runs
and also ReaR&#8217;s current progress subsystem is not prepared for that.
On the terminal the messages from different simultaneous runs are
indistinguishable and the current progress subsystem additionally
outputs subsequent messages on one same line which results
illegible and meaningless output on the terminal.</p></div>
<div class="paragraph"><p>Therefore additional parameters must be set to make ReaR&#8217;s messages
and the progress subsystem output appropriate for parallel runs.</p></div>
<div class="paragraph"><p>Simultaneously running ReaR workflows require unique messages and
unique logfile names.</p></div>
<div class="paragraph"><p>Therefore the PID (<em>$$</em>) is specified to be used as message prefix
for all ReaR messages and it is also added to the LOGFILE value.</p></div>
<div class="paragraph"><p>The parameters MESSAGE_PREFIX PROGRESS_MODE and PROGRESS_WAIT_SECONDS
are described in conf/default.conf.</p></div>
<div class="paragraph"><p>For example a setup for parallel runs of mkbackuponly and restoreonly
could look like the following:</p></div>
<div class="listingblock">
<div class="title">/etc/rear/local.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">OUTPUT</span><span style="color: #990000">=</span>ISO
<span style="color: #009900">BACKUP</span><span style="color: #990000">=</span>NETFS
<span style="color: #009900">BACKUP_OPTIONS</span><span style="color: #990000">=</span><span style="color: #FF0000">"nfsvers=3,nolock"</span>
<span style="color: #009900">BACKUP_URL</span><span style="color: #990000">=</span>nfs<span style="color: #990000">:</span>//your<span style="color: #990000">.</span>NFS<span style="color: #990000">.</span>server<span style="color: #990000">.</span>IP/path/to/your/rear/backup
<span style="color: #009900">MESSAGE_PREFIX</span><span style="color: #990000">=</span><span style="color: #FF0000">"$$: "</span>
<span style="color: #009900">PROGRESS_MODE</span><span style="color: #990000">=</span><span style="color: #FF0000">"plain"</span>
<span style="color: #009900">PROGRESS_WAIT_SECONDS</span><span style="color: #990000">=</span><span style="color: #FF0000">"3"</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/basic_system.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}-$$.log"</span>
<span style="color: #009900">BACKUP_PROG_EXCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">"${BACKUP_PROG_EXCLUDE[@]}"</span> <span style="color: #FF0000">'/home/*'</span> <span style="color: #FF0000">'/opt/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BACKUP_PROG_ARCHIVE</span><span style="color: #990000">=</span><span style="color: #FF0000">"backup-${this_file_name%.*}"</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">/etc/rear/home_backup.conf</div>
<div class="content">
<pre><code>this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}-$$.log"
BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( '/home/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</code></pre>
</div></div>
<div class="listingblock">
<div class="title">/etc/rear/opt_backup.conf</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">this_file_name</span><span style="color: #990000">=</span><span style="color: #009900">$(</span> basename <span style="color: #009900">${BASH_SOURCE[0]}</span> <span style="color: #990000">)</span>
<span style="color: #009900">LOGFILE</span><span style="color: #990000">=</span><span style="color: #FF0000">"$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}-$$.log"</span>
<span style="color: #009900">BACKUP_ONLY_INCLUDE</span><span style="color: #990000">=</span><span style="color: #FF0000">"yes"</span>
<span style="color: #009900">BACKUP_PROG_INCLUDE</span><span style="color: #990000">=(</span> <span style="color: #FF0000">'/opt/*'</span> <span style="color: #990000">)</span>
<span style="color: #009900">BACKUP_PROG_ARCHIVE</span><span style="color: #990000">=</span><span style="color: #FF0000">"backup-${this_file_name%.*}"</span></tt></pre></div></div>
<div class="paragraph"><p>With those config files creating the ReaR recovery/rescue system ISO image
together with a backup of the files of the basic system and then
backup the files in /home and /opt in parallel could be done like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system mkbackup
rear -C home_backup mkbackuponly &amp; rear -C opt_backup mkbackuponly &amp; wait</code></pre>
</div></div>
<div class="paragraph"><p>Recovery of that system could be done by calling in the
ReaR recovery/rescue system:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rear -C basic_system recover
rear -C home_backup restoreonly &amp; rear -C opt_backup restoreonly &amp; wait</code></pre>
</div></div>
<div class="paragraph"><p>Even on a relatively small system with a single CPU
running multiple backups and restores in parallel
can be somewhat faster compared to sequential processing.</p></div>
<div class="paragraph"><p>On powerful systems with multiple CPUs, much main memory, fast storage access,
and fast access to the backups it is in practice mandatory to split
a single huge backup of the whole system into separated parts and
run at least the restores in parallel to utilize powerful hardware
and be as fast as possible in case of emergency and time pressure
during a real disaster recovery.</p></div>
<div class="paragraph"><p>Remember that system recovery with multiple backups requires that
first and foremost the basic system is recovered where all files
must be restored that are needed to install the bootloader and
to boot the basic system into a normal usable state so that
<em>rear recover</em> cannot run in parallel with <em>rear restoreonly</em>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_blockclone_as_backup_method">12. BLOCKCLONE as backup method</h2>
<div class="sectionbody">
<div class="paragraph"><p>BLOCKCLONE backup method is a bit distinct type of backup, which works directly
 with block devices. It allows running backups of any kind of block device that
 can be read/write by Linux drivers and save them to e.g. NFS share or USB
 drive for later restore. It currently integrates Disk Dump (dd) and ntfsclone
 (from ntfs-3g package). With BLOCKCLONE, user is also able to make full backup
 and restore of dual boot (Linux / Windows) environments.</p></div>
<div class="sect2">
<h3 id="_limitations">12.1. Limitations</h3>
<div class="ulist"><ul>
<li>
<p>
Works only directly with disk partitions
</p>
</li>
<li>
<p>
GPT not supported (work in progress)
</p>
</li>
<li>
<p>
No UEFI support (work in progress)
</p>
</li>
<li>
<p>
Linux family boot loader must be used as primary
 (Windows bootloader was not tested)
</p>
</li>
<li>
<p>
Restore should be done to same sized or larger disks
</p>
</li>
<li>
<p>
Tests were made with Windows 7/10 with NFS and USB as destinations.
 Other ReaR backup destinations like SMB or FTP might however work as well.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_warning">12.2. Warning!</h3>
<div class="paragraph"><p>ReaR with BLOCKCLONE is capable of doing backup of Linux/Windows dual boot
 environments. There is however a need for some basic knowledge on how is
 source OS setup. Things like boot loader device location, Linux/Windows
 partitioning and file system layout are essential for backup setup.<br />
<strong>Always test before you rely!</strong></p></div>
</div>
<div class="sect2">
<h3 id="_examples">12.3. Examples</h3>
<div class="sect3">
<h4 id="_1_backup_restore_of_arbitrary_block_device_with_blockclone_and_dd_on_nfs_server">12.3.1. 1. Backup/restore of arbitrary block device with BLOCKCLONE and dd on NFS server</h4>
<div class="sect4">
<h5 id="_configuration_3">Configuration</h5>
<div class="paragraph"><p>This is very basic and most simple scenario where we will do backup
of single partition (<em>/dev/sdc1</em>) located on separate disk (<em>/dev/sdc</em>).<br />
First we need to set some global options in <em>local.conf</em>,
 like target for backups.
In our small example backups will be stored in <em>/mnt/rear</em> directory
 on BACKUP_URL NFS server.</p></div>
<div class="paragraph"><p>```
# cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://&lt;hostname&gt;/mnt/rear
```</p></div>
<div class="paragraph"><p>Now we will define variables that will apply only for targeted block device</p></div>
<div class="paragraph"><p>```
# cat alien.conf
BACKUP=BLOCKCLONE                                        # Define BLOCKCLONE as backup method
BACKUP_PROG_ARCHIVE="alien"                              # Name of image file
BACKUP_PROG_SUFFIX=".dd.img"                             # Suffix of image file
BACKUP_PROG_COMPRESS_SUFFIX=""                           # Don&#8217;t use additional suffixes</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=dd                                       # Use dd for image creation
BLOCKCLONE_PROG_OPTS="bs=4k"                             # Additional options that will be passed to dd
BLOCKCLONE_SOURCE_DEV="/dev/sdc1"                        # Device that should be backed up</p></div>
<div class="paragraph"><p>BLOCKCLONE_SAVE_MBR_DEV="/dev/sdc"                       # Device where partitioning information is stored (optional)
BLOCKCLONE_MBR_FILE="alien_boot_strap.img"               # Output filename for boot strap code
BLOCKCLONE_PARTITIONS_CONF_FILE="alien_partitions.conf"  # Output filename for partition configuration</p></div>
<div class="paragraph"><p>BLOCKCLONE_ALLOW_MOUNTED="yes"                           # Device can be mounted during backup (default NO)
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_backup_2">Running backup</h5>
<div class="paragraph"><p>Save partitions configuration, bootstrap code and create actual backup of /dev/sdc1
```
# rear -C alien mkbackuponly
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restore_recovery_system">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph"><p>```
# rear -C alien restoreonly
Restore alien.dd.img to device: [/dev/sdc1]                 # User is always prompted for restore destination
Device /dev/sdc1 was not found.                             # If destination does not exist ReaR will try to create it (or fail if BLOCKCLONE_SAVE_MBR_DEV was not set during backup)
Restore partition layout to (^c to abort): [/dev/sdc]       # Prompt user for device where partition configuration should be restored
Checking that no-one is using this disk right now &#8230; OK</p></div>
<div class="paragraph"><p>Disk /dev/sdc: 5 GiB, 5368709120 bytes, 10485760 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes</p></div>
<div class="paragraph"><p>&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Created a new DOS disklabel with disk identifier 0x10efb7a9.
Created a new partition 1 of type <em>HPFS/NTFS/exFAT</em> and of size 120 MiB.
/dev/sdc2:
New situation:</p></div>
<div class="paragraph"><p>Device     Boot Start    End Sectors  Size Id Type
/dev/sdc1        4096 249855  245760  120M  7 HPFS/NTFS/exFAT</p></div>
<div class="paragraph"><p>The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
```</p></div>
</div>
<div class="sect4">
<h5 id="_summary">Summary</h5>
<div class="paragraph"><p>In first example we have run backup of /dev/sdc1 partition and stored it on NFS
 server. Saved image was later restored from ReaR rescue/recovery system.
ReaRs BLOCKCLONE will always ask user for restore destination, so it is users
 responsibility to identify right target disk/partition prior restore.
 Unlike NETFS backup method, no guesses about target devices will be made!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">One of easiest ways how to identify right disk could be its size.<br />
Running <code>fdisk -l &lt;device_file&gt;</code> could be helpful.</td>
</tr></table>
</div>
<div class="paragraph"><p>During restore phase ReaR recognized that target partition does not exist and
 asked if it should be created. If restore destination does not exist and
 BLOCKCLONE_SAVE_MBR_DEV was set during backup, ReaR will try to deploy
 partition setup from saved configuration files (BLOCKCLONE_MBR_FILE and
 BLOCKCLONE_PARTITIONS_CONF_FILE) and continue with restore.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_2_backup_restore_of_linux_windows_10_dual_boot_setup_with_each_os_on_separate_disk">12.3.2. 2. Backup/restore of Linux / Windows 10 dual boot setup with each OS on separate disk</h4>
<div class="sect4">
<h5 id="_configuration_4">Configuration</h5>
<div class="paragraph"><p>In next example we will do backup/restore using BLOCKCLONE and <code>ntfsclone</code>
 of Linux (installed on /dev/sda) and Windows 10 (installed on /dev/sdb).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">You can locate right disk devices using <code>df</code> and <code>os-prober</code>
```
# df -h /boot
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        10G  4.9G  5.2G  49% /           # Linux is most probably installed on /dev/sda</td>
</tr></table>
</div>
<div class="paragraph"><p># os-prober
/dev/sdb1:Windows 10 (loader):Windows:chain       # Windows 10 is most probably installed on /dev/sdb
```</p></div>
<div class="paragraph"><p>First we will configure some ReaR backup global options
 (similar to <a href="12-BLOCKCLONE.adoc#1-backuprestore-of-arbitrary-block-device-with-blockclone-and-dd-on-nfs-server">first example</a>
 we will do backup/restore with help of NFS server).</p></div>
<div class="paragraph"><p>```
# cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://&lt;hostname&gt;/mnt/rear
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" ntfsclone )
```</p></div>
<div class="paragraph"><p>Now we will define backup parameters for Linux.</p></div>
<div class="paragraph"><p>```
# cat base_os.conf
this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-$.<strong>.log"
BACKUP_PROG_ARCHIVE="backup-$.</strong>"
BACKUP_PROG_EXCLUDE=( ${BACKUP_PROG_EXCLUDE[@]} <em>/media/*</em> )
```</p></div>
<div class="paragraph"><p>Our Windows 10 is by default installed on two separate partitions
 (partition 1 for boot data and partition 2 for disk C:),
 so we will create two separate configuration files for each partition.</p></div>
<div class="paragraph"><p>Windows boot partition:</p></div>
<div class="paragraph"><p>```
# cat windows_boot.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_boot"
BACKUP_PROG_SUFFIX=".img"
BACKUP_PROG_COMPRESS_SUFFIX=""</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_SOURCE_DEV="/dev/sdb1"
BLOCKCLONE_PROG_OPTS="--quiet"</p></div>
<div class="paragraph"><p>BLOCKCLONE_SAVE_MBR_DEV="/dev/sdb"
BLOCKCLONE_MBR_FILE="windows_boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="windows_partitions.conf"
```</p></div>
<div class="paragraph"><p>Windows data partition (disk C:\):
```
# cat windows_data.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_data"
BACKUP_PROG_SUFFIX=".img"
BACKUP_PROG_COMPRESS_SUFFIX=""</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_SOURCE_DEV="/dev/sdb2"
BLOCKCLONE_PROG_OPTS="--quiet"</p></div>
<div class="paragraph"><p>BLOCKCLONE_SAVE_MBR_DEV="/dev/sdb"
BLOCKCLONE_MBR_FILE="windows_boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="windows_partitions.conf"
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_backup_3">Running backup</h5>
<div class="paragraph"><p>First we will create backup of Linux. <code>mkbackup</code> command will create bootable
 ISO image with ReaR rescue/recovery system that will be later used for
 booting broken system and consecutive recovery.
```
# rear -C base_os mkbackup
```</p></div>
<div class="paragraph"><p>Now we create backup of Windows 10 boot partition. Command <code>mkbackuponly</code>
 will ensure that only partition data and partition layout will be saved
 (ReaR rescue/recovery system will not be created which is exactly what we want).
```
# rear -C windows_boot mkbackuponly
```</p></div>
<div class="paragraph"><p>Similarly, we create backup of Windows 10 data partition (disk C:\)
```
# rear -C windows_data mkbackuponly
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restore_recovery_system_2">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph"><p>As a first step after ReaR rescue/recovery system booted,
we will recover Linux. This step will recover all Linux file systems,
OS data and bootloader. Windows disk will remain untouched.
```
# rear -C base_os recover
```</p></div>
<div class="paragraph"><p>In second step will recover Windows 10 boot partition. During this step ReaR
 will detect that destination partition is not present and ask us for device
 file where partition(s) should be created. It doesn&#8217;t really matter whether
 we decide to recover Windows 10 boot or data partition first.
 <code>restoreonly</code> command ensures that previously restored Linux data and
 partition(s) configuration (currently mounted under <em>/mnt/local</em>) will
 remain untouched. Before starting Windows 10 recovery we should identify
 right disk for recovery, as mentioned earlier disk size could be a good start.
```
# fdisk -l /dev/sdb
Disk /dev/sdb: 50 GiB, 53687091200 bytes, 104857600 sectors
```</p></div>
<div class="paragraph"><p><em>/dev/sdb</em> looks to be right destination, so we can proceed with restore.
```
# rear -C windows_boot restoreonly
Restore windows_boot.img to device: [/dev/sdb1]
Device /dev/sdb1 was not found.
Restore partition layout to (^c to abort): [/dev/sdb]
Checking that no-one is using this disk right now &#8230; OK
&#8230;
```</p></div>
<div class="paragraph"><p>Last step is to recover Windows 10 OS data (C:\).
Partitions on <em>/dev/sdb</em> were already created in previous step,
hence ReaR will skip prompt for restoring partition layout.
```
# rear -C windows_data restoreonly
Restore windows_data.img to device: [/dev/sdb2]
Ntfsclone image version: 10.1
Cluster size           : 4096 bytes
Image volume size      : 33833349120 bytes (33834 MB)
Image device size      : 33833353216 bytes
Space in use           : 9396 MB (27.8%)
Offset to image data   : 56 (0x38) bytes
Restoring NTFS from image &#8230;
&#8230;
```</p></div>
<div class="paragraph"><p>At this stage Linux together with Windows 10 is successfully restored.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">As Linux part is still mounted under <em>/mnt/local</em>, you can do some
 final configuration changes. e.g. adapt GRUB configuration, /etc/fstab,
 reinstall boot loader &#8230;</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">ReaR will by default not include tools for mounting NTFS file systems. You
 can do it manually by adding
 <code>REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" ntfsclone mount.ntfs-3g )</code>
 to your <em>local.conf</em></td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_3_backup_restore_of_linux_windows_10_dual_boot_setup_sharing_same_disk">12.3.3. 3. Backup/restore of Linux / Windows 10 dual boot setup sharing same disk</h4>
<div class="sect4">
<h5 id="_configuration_5">Configuration</h5>
<div class="paragraph"><p>In this example we will do backup/restore using BLOCKCLONE and <code>ntfsclone</code>
 of Linux and Windows 10 installed on same disk (<em>/dev/sda</em>).
 Linux is installed on partition <em>/dev/sda3</em>. Windows 10 is again divided into
 boot partition located on <em>/dev/sda1</em> and OS data (C:/) located on <em>/dev/sda2</em>.
 Backups will be stored on NFS server.</p></div>
<div class="paragraph"><p>First we set global ReaR options
```
# cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://&lt;hostname&gt;/mnt/rear
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" ntfsclone )</p></div>
<div class="paragraph"><p>BLOCKCLONE_STRICT_PARTITIONING="yes"
BLOCKCLONE_SAVE_MBR_DEV="/dev/sda"</p></div>
<div class="paragraph"><p>BLOCKCLONE_MBR_FILE="boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="partitions.conf"</p></div>
<div class="paragraph"><p>```</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">BLOCKCLONE_STRICT_PARTITIONING is mandatory if backing up
 Linux / Windows that shares one disk. Not using this option might result to
 unbootable Windows 10 installation.</td>
</tr></table>
</div>
<div class="paragraph"><p>Linux configuration
```
# cat base_os.conf
this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-$.<strong>.log"
BACKUP_PROG_ARCHIVE="backup-$.</strong>"
BACKUP_PROG_EXCLUDE=( ${BACKUP_PROG_EXCLUDE[@]} <em>/media/*</em> )
```</p></div>
<div class="paragraph"><p>Windows 10 boot partition configuration
```
# cat windows_boot.conf
BACKUP=BLOCKCLONE</p></div>
<div class="paragraph"><p>BACKUP_PROG_ARCHIVE="windows_boot"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"</p></div>
<div class="paragraph"><p>BLOCKCLONE_SOURCE_DEV="/dev/sda1"
```</p></div>
<div class="paragraph"><p>Windows 10 data partition configuration
```
# cat windows_data.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_data"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"</p></div>
<div class="paragraph"><p>BLOCKCLONE_SOURCE_DEV="/dev/sda2"
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_backup_4">Running backup</h5>
<div class="paragraph"><p>Backup of Linux
```
# rear -C base_os mkbackup
```</p></div>
<div class="paragraph"><p>Backup of Windows 10 boot partition
```
# rear -C windows_boot mkbackuponly
```</p></div>
<div class="paragraph"><p>Backup of Windows 10 data partition
```
# rear -C windows_data mkbackuponly
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restore_recovery_system_3">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph"><p>Restore Linux
```
# rear -C base_os recover
```</p></div>
<div class="paragraph"><p>During this step ReaR will also create both Windows 10 partitions</p></div>
<div class="paragraph"><p>Restore Windows 10 data partition
```
# rear -C windows_data restoreonly
```</p></div>
<div class="paragraph"><p>Restore Windows 10 boot partition
```
# rear -C windows_boot restoreonly
```</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_4_backup_restore_of_linux_windows_10_dual_boot_setup_sharing_same_disk_with_usb_as_destination">12.3.4. 4. Backup/restore of Linux / Windows 10 dual boot setup sharing same disk with USB as destination</h4>
<div class="sect4">
<h5 id="_configuration_6">Configuration</h5>
<div class="paragraph"><p>In this example we will do backup/restore using BLOCKCLONE and <code>ntfsclone</code>
 of Linux and Windows 10 installed on same disk (<em>/dev/sda</em>).
 Linux is installed on partition <em>/dev/sda3</em>. Windows 10 is again divided into
 boot partition located on <em>/dev/sda1</em> and OS data (C:/) located on <em>/dev/sda2</em>.
 Backups will be stored on USB disk drive (<em>/dev/sdb</em> in this example).</p></div>
<div class="paragraph"><p>Global options
```
# cat local.conf
OUTPUT=USB
BACKUP=NETFS</p></div>
<div class="paragraph"><p>USB_DEVICE=/dev/disk/by-label/REAR-000
BACKUP_URL=usb:///dev/disk/by-label/REAR-000</p></div>
<div class="paragraph"><p>USB_SUFFIX="USB_backups"</p></div>
<div class="paragraph"><p>GRUB_RESCUE=n
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" ntfsclone )</p></div>
<div class="paragraph"><p>BLOCKCLONE_STRICT_PARTITIONING="yes"
BLOCKCLONE_SAVE_MBR_DEV="/dev/sda"</p></div>
<div class="paragraph"><p>BLOCKCLONE_MBR_FILE="boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="partitions.conf"
```</p></div>
<div class="paragraph"><p>Options used during Linux backup/restore.
```
# cat local.conf
OUTPUT=USB
BACKUP=NETFS</p></div>
<div class="paragraph"><p>USB_DEVICE=/dev/disk/by-label/REAR-000
BACKUP_URL=usb:///dev/disk/by-label/REAR-000</p></div>
<div class="paragraph"><p>USB_SUFFIX="USB_backups"</p></div>
<div class="paragraph"><p>GRUB_RESCUE=n
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" ntfsclone )</p></div>
<div class="paragraph"><p>BLOCKCLONE_STRICT_PARTITIONING="yes"
BLOCKCLONE_SAVE_MBR_DEV="/dev/sda"</p></div>
<div class="paragraph"><p>BLOCKCLONE_MBR_FILE="boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="partitions.conf"
```</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">USB_SUFFIX option is mandatory as it avoids ReaR to hold every
 backup in separate directory, this behavior is essential for BLOCKCLONE
 backup method to work correctly.</td>
</tr></table>
</div>
<div class="paragraph"><p>Windows boot partition options
```
# cat windows_boot.conf
BACKUP=BLOCKCLONE</p></div>
<div class="paragraph"><p>BACKUP_PROG_ARCHIVE="windows_boot"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"</p></div>
<div class="paragraph"><p>BLOCKCLONE_SOURCE_DEV="/dev/sda1"
```</p></div>
<div class="paragraph"><p>Windows data partition options
```
# cat windows_data.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_data"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""</p></div>
<div class="paragraph"><p>BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"</p></div>
<div class="paragraph"><p>BLOCKCLONE_SOURCE_DEV="/dev/sda2"
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_backup_5">Running backup</h5>
<div class="paragraph"><p>First we need to format target USB device, with <code>rear format</code> command
```
# rear -v format /dev/sdb
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-centosd.log
USB device /dev/sdb is not formatted with ext2/3/4 or btrfs filesystem
Type exactly <em>Yes</em> to format /dev/sdb with ext3 filesystem: Yes
Repartitioning <em>/dev/sdb</em>
Creating partition table of type <em>msdos</em> on <em>/dev/sdb</em>
Creating ReaR data partition up to 100% of <em>/dev/sdb</em>
Setting <em>boot</em> flag on /dev/sdb
Creating ext3 filesystem with label <em>REAR-000</em> on <em>/dev/sdb1</em>
Adjusting filesystem parameters on <em>/dev/sdb1</em>
```</p></div>
<div class="paragraph"><p>Backup of Linux
```
# rear -C base_os mkbackup
```</p></div>
<div class="paragraph"><p>Backup of Windows 10 boot partition
```
# rear -C windows_boot mkbackuponly
NTFS volume version: 3.1
Cluster size       : 4096 bytes
Current volume size: 524283904 bytes (525 MB)
Current device size: 524288000 bytes (525 MB)
Scanning volume &#8230;
Accounting clusters &#8230;
Space in use       : 338 MB (64.4%)
Saving NTFS to image &#8230;
Syncing &#8230;
```</p></div>
<div class="paragraph"><p>Backup of Windows 10 data partition
```
# rear -C windows_data mkbackuponly
NTFS volume version: 3.1
Cluster size       : 4096 bytes
Current volume size: 18104709120 bytes (18105 MB)
Current device size: 18104713216 bytes (18105 MB)
Scanning volume &#8230;
Accounting clusters &#8230;
Space in use       : 9833 MB (54.3%)
Saving NTFS to image &#8230;
Syncing &#8230;
```</p></div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restore_recovery_system_4">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph"><p>For sake of this demonstration I&#8217;ve purposely used ReaR&#8217;s rescue/recovery media
 (USB disk that holds our backed up Linux and Windows 10) as <em>/dev/sda</em> and
 disk that will be used as restore destination as <em>/dev/sdb</em>. This will
 demonstrate possibility of ReaR to recover backup to arbitrary disk.<br />
As first step Linux will be restored, this will create all the partitions
 needed, even those used by Windows 10.
```
RESCUE centosd:~ # rear -C base_os recover
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-centosd.log
Sourcing additional configuration file <em>/etc/rear/base_os.conf</em>
Running workflow recover within the ReaR rescue/recovery system
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper <em>rpcbind</em>.
RPC portmapper <em>rpcbind</em> available.
Started rpc.statd.
RPC status rpc.statd available.
Using backup archive <em>/tmp/rear.70zIHqCYsIbtlr6/outputfs/centosd/backup-base_os.tar.gz</em>
Calculating backup archive size
Backup archive size is 1001M    /tmp/rear.70zIHqCYsIbtlr6/outputfs/centosd/backup-base_os.tar.gz (compressed)
Comparing disks.
Device sda has size 15733161984, 37580963840 expected
Switching to manual disk layout configuration.
Original disk /dev/sda does not exist in the target system. Please choose an appropriate replacement.
1) /dev/sda
2) /dev/sdb
3) Do not map disk.
#?
```</p></div>
<div class="paragraph"><p>Now ReaR recover command stops as it detected that disk layout is not identical.
 As our desired restore target is <em>/dev/sdb</em> we choose right disk and continue
 recovery. ReaR will ask to check created restore scripts, but this is not
 needed in our scenario.
```
#? 2
2017-01-25 20:54:01 Disk /dev/sdb chosen as replacement for /dev/sda.
Disk /dev/sdb chosen as replacement for /dev/sda.
This is the disk mapping table:
    /dev/sda /dev/sdb
Please confirm that <em>/var/lib/rear/layout/disklayout.conf</em> is as you expect.</p></div>
<div class="paragraph"><p>1) View disk layout (disklayout.conf)  4) Go to Relax-and-Recover shell
2) Edit disk layout (disklayout.conf)  5) Continue recovery
3) View original disk space usage      6) Abort Relax-and-Recover
#? 5
Partition primary on /dev/sdb: size reduced to fit on disk.
Please confirm that <em>/var/lib/rear/layout/diskrestore.sh</em> is as you expect.</p></div>
<div class="paragraph"><p>1) View restore script (diskrestore.sh)
2) Edit restore script (diskrestore.sh)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#? 5
Start system layout restoration.
Creating partitions for disk /dev/sdb (msdos)</p></div>
<div class="paragraph"><p>Disk /dev/sdb: 6527 cylinders, 255 heads, 63 sectors/track
Old situation:
Units: cylinders of 8225280 bytes, blocks of 1024 bytes, counting from 0</p></div>
<div class="literalblock">
<div class="content">
<pre><code>   Device Boot Start     End   #cyls    #blocks   Id  System
/dev/sdb1   *      0+     91-     92-    731449   83  Linux
/dev/sdb2         91+   3235-   3145-  25258396+  83  Linux
/dev/sdb3       3235+   6527-   3292-  26436900   83  Linux
/dev/sdb4          0       -       0          0    0  Empty
New situation:
Units: sectors of 512 bytes, counting from 0</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>   Device Boot    Start       End   #sectors  Id  System
/dev/sdb1   *      2048   1026047    1024000   7  HPFS/NTFS/exFAT
/dev/sdb2       1026048  36386815   35360768   7  HPFS/NTFS/exFAT
/dev/sdb3      36386816  73400319   37013504  83  Linux
/dev/sdb4             0         -          0   0  Empty
Successfully wrote the new partition table</code></pre>
</div></div>
<div class="paragraph"><p>Re-reading the partition table &#8230;</p></div>
<div class="paragraph"><p>Creating filesystem of type xfs with mount point / on /dev/sdb3.
Mounting filesystem /
Disk layout created.
Restoring from <em>/tmp/rear.70zIHqCYsIbtlr6/outputfs/centosd/backup-base_os.tar.gz</em>&#8230;
Restoring usr/lib/modules/3.10.0-514.2.2.el7.x86_64/kernel/drivers/net/wireless/realtek/rtlwifi/rtl8723be/rtl8723be.koRestoring var/log/rear/rear-centosd.log OK
Restored 2110 MiB in 103 seconds [avg. 20977 KiB/sec]
Restoring finished.
Restore the Mountpoints (with permissions) from /var/lib/rear/recovery/mountpoint_permissions
Patching <em>/etc/default/grub</em> instead of <em>etc/sysconfig/grub</em>
Patching <em>/proc/1909/mounts</em> instead of <em>etc/mtab</em>
Skip installing GRUB Legacy boot loader because GRUB 2 is installed (grub-probe or grub2-probe exist).
Installing GRUB2 boot loader
Finished recovering your system. You can explore it under <em>/mnt/local</em>.
Saving /var/log/rear/rear-centosd.log as /var/log/rear/rear-centosd-recover-base_os.log
```</p></div>
<div class="paragraph"><p>Now we have Linux part restored, GRUB installed and partitions created, hence
 we can continue with Windows 10 boot partition recovery.
```
RESCUE centosd:~ # rear -C windows_boot restoreonly
Restore windows_boot.nc.img to device: [/dev/sda1] /dev/sdb1
Ntfsclone image version: 10.1
Cluster size           : 4096 bytes
Image volume size      : 524283904 bytes (525 MB)
Image device size      : 524288000 bytes
Space in use           : 338 MB (64.4%)
Offset to image data   : 56 (0x38) bytes
Restoring NTFS from image &#8230;
Syncing &#8230;
```</p></div>
<div class="paragraph"><p>Similarly to Linux restore, we were prompted for restore destination, which
 is /dev/sdb1 in our case.<br />
As the last step we will recover Windows 10 data partition
```
RESCUE centosd:~ # rear -C windows_data restoreonly
Restore windows_data.nc.img to device: [/dev/sda2] /dev/sdb2
Ntfsclone image version: 10.1
Cluster size           : 4096 bytes
Image volume size      : 18104709120 bytes (18105 MB)
Image device size      : 18104713216 bytes
Space in use           : 9867 MB (54.5%)
Offset to image data   : 56 (0x38) bytes
Restoring NTFS from image &#8230;
Syncing &#8230;
```</p></div>
<div class="paragraph"><p>Again after restoreonly command is launched, ReaR prompts for restore
 destination.<br />
Now both operating systems are restored and we can reboot.</p></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2017-09-24 14:05:19 CEST
</div>
</div>
</body>
</html>
